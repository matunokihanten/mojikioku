<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å››å­—ç†Ÿèªãƒ»æ–‡å­—ä¸¦ã¹ã‹ãˆè„³ãƒˆãƒ¬ (è‡ªå‹•æ¬¡ã¸)</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
  /* --- ãƒ™ãƒ¼ã‚¹ãƒ‡ã‚¶ã‚¤ãƒ³ã¨å¤‰æ•° --- */
  :root{
    --bg: #f3f7fb; /* æ˜ã‚‹ã„èƒŒæ™¯ */
    --card: #ffffff;
    --accent: #2563eb; /* é’ç³»ã‚’ãƒ¡ã‚¤ãƒ³ã« */
    --accent-light: #eff6ff; /* è–„ã„ã‚¢ã‚¯ã‚»ãƒ³ãƒˆè‰² */
    --ok: #16a34a; /* ç·‘ */
    --ng: #dc2626; /* èµ¤ */
    --muted: #64748b; /* ã‚°ãƒ¬ãƒ¼ */
    --border: #e2e8f0;
    --shadow: 0 4px 15px rgba(15, 23, 42, 0.05);
    font-family: "Noto Sans JP", system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "ãƒ¡ã‚¤ãƒªã‚ª", Meiryo, sans-serif;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  .app{
    width:100%;
    max-width:960px; /* å°‘ã—åºƒã */
    background:var(--card);
    border-radius:16px;
    box-shadow:var(--shadow);
    padding:24px;
  }
  
  /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
  header{
    display:flex;
    gap:16px;
    align-items:flex-start;
    justify-content:space-between;
    margin-bottom:20px;
    flex-wrap: wrap; /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
  }
  h1{
    margin:0;
    font-size:24px;
    font-weight:700;
    color:#1f2937;
    line-height:1.4;
  }
  .subtitle{font-size:14px;color:var(--muted);margin-top:4px;}
  .meta{
    display:flex;
    gap:15px;
    align-items:center;
    font-size:14px;
    color:var(--muted);
    padding:8px;
    border:1px solid var(--border);
    border-radius:8px;
  }
  
  /* --- ãƒœã‚¿ãƒ³ --- */
  .controls{display:flex;gap:10px;align-items:center;}
  .btn{
    background:transparent;
    border:1px solid var(--border);
    padding:10px 14px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
    font-size:14px;
    transition:all .15s;
    line-height:1;
    white-space:nowrap;
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 2px 5px rgba(0,0,0,0.05);}
  .btn-primary{
    background:var(--accent);
    color:#fff;
    border:none;
  }
  .btn-primary:hover{background:rgb(29, 78, 216);}
  .btn-ghost{background:var(--accent-light);border:1px solid var(--accent);color:var(--accent);}
  
  /* --- ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
  main{display:grid;grid-template-columns:1fr 340px;gap:24px;}
  @media (max-width:900px){ main{grid-template-columns:1fr;}}
  .card{
    background:var(--card);
    border-radius:12px;
    padding:18px;
    border:1px solid var(--border);
    box-shadow:0 1px 3px rgba(0,0,0,0.02);
  }

  /* --- å•é¡Œå‘¨ã‚Š --- */
  .top-bar{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    margin-bottom:15px;
    flex-wrap: wrap;
  }
  .controls-row{display:flex;gap:8px;flex-wrap:wrap;}
  .info{
    display:flex;align-items:center;justify-content:space-between;
    padding:10px 0;
    border-bottom:1px solid var(--border);
    margin-bottom:15px;
  }
  .word-area{
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:flex-start;
    justify-content:center;
  }

  /* --- å›ç­”ã‚¨ãƒªã‚¢ã®æ”¹å–„ --- */
  .answer-area{
    display:flex;gap:12px;align-items:center;flex-wrap:wrap;
    min-height:70px;
    padding:16px;
    border-radius:10px;
    border:3px dashed var(--accent-light); /* å¤ªãã™ã‚‹ */
    background:var(--accent-light);
    width:100%;
  }
  .picked-label{font-size:14px;color:#1f2937;font-weight:700;margin-bottom:-4px;}

  /* --- æ–‡å­—ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆãƒãƒ£ãƒ¼ãƒ ï¼‰ --- */
  .char {
    background:linear-gradient(180deg,#ffffff,#f1f5f9);
    border-radius:8px;
    padding:12px 14px;
    font-size:26px; /* å¤§ãã */
    font-weight:700;
    cursor:pointer;
    user-select:none;
    border:2px solid var(--border);
    transition:transform .1s, background .15s, border-color .15s;
    box-shadow:0 2px 4px rgba(0,0,0,0.05);
    line-height:1;
  }
  .char:hover{border-color:var(--accent);}
  .char:active{transform:scale(.97);}
  .char.disabled{opacity:.4;cursor:not-allowed;background:#f9fafb;border-color:var(--border);}

  .pool{
    margin-top:4px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .small-muted{font-size:13px;color:var(--muted);}
  .hint{font-size:14px;color:#333;font-weight:500;}

  /* --- çµæœè¡¨ç¤º --- */
  .result{
    margin-top:15px;
    padding:12px;border-radius:10px;
    font-weight:700;
    display:flex;align-items:center;gap:10px;
  }
  .result.ok{background:rgba(22,163,74,0.1);color:var(--ok);border:1px solid var(--ok)}
  .result.ng{background:rgba(220,38,38,0.08);color:var(--ng);border:1px solid var(--ng)}
  .result-icon{font-size:18px;}

  /* --- å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ --- */
  .side {
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .stat{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
  }
  .big{font-size:26px;font-weight:700;color:#1f2937;}
  .small{font-size:13px;color:var(--muted)}
  .footer-actions{display:flex;gap:8px;flex-wrap:wrap}
  .switch{
    display:inline-flex;align-items:center;gap:8px;font-size:14px;color:#333;
  }
  input[type=checkbox]{transform:scale(1.1);}
  input[type=number]{
    width:80px;padding:8px;border-radius:8px;border:1px solid var(--border);
    text-align:right;font-size:14px;
  }
  .timer{font-weight:700;color:var(--ng);} /* ã‚¿ã‚¤ãƒãƒ¼ã‚’èµ¤ã */

  footer{margin-top:20px;font-size:12px;color:var(--muted);text-align:center}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="å››å­—ç†Ÿèªä¸¦ã¹æ›¿ãˆè„³ãƒˆãƒ¬ã‚²ãƒ¼ãƒ ">
    <header>
      <div>
        <h1>å››å­—ç†Ÿèª æ–‡å­—ä¸¦ã¹ã‹ãˆ â€” è„³ãƒˆãƒ¬</h1>
        <div class="subtitle">æ–‡å­—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ­£ã—ã„**å››å­—ç†Ÿèª**ã«ä¸¦ã¹æ›¿ãˆã‚ˆã†ï¼</div>
      </div>
      <div class="controls">
        <div class="meta">
          <div class="small-muted">å•é¡Œæ•°: <strong>100</strong></div>
          <div class="small-muted">é›£æ˜“åº¦: <strong>å››å­—ç†Ÿèª</strong></div>
        </div>
      </div>
    </header>

    <main>
      <section>
        <div class="card">
          <div class="top-bar">
            <div>
              <div class="small-muted">å‡ºé¡Œ</div>
              <div style="font-size:16px;font-weight:700" id="q-index">å•é¡Œ 1 / â€”</div>
            </div>
            <div class="controls-row">
              <button class="btn btn-ghost" id="shuffleBtn" title="æ–‡å­—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
              <button class="btn" id="showAnswerBtn" title="ç­”ãˆã‚’è¡¨ç¤º">ç­”ãˆã‚’è¡¨ç¤º</button>
              <button class="btn" id="resetBtn" title="ä»Šã®è§£ç­”ã‚’ãƒªã‚»ãƒƒãƒˆ">ãƒªã‚»ãƒƒãƒˆ</button>
              <button class="btn btn-primary" id="checkBtn" title="è§£ç­”ã‚’åˆ¤å®š">åˆ¤å®š</button>
              <button class="btn" id="nextBtn" title="æ¬¡ã®å•é¡Œ">æ¬¡ã¸</button>
            </div>
          </div>

          <div class="info">
            <div>
              <div class="small-muted">ãƒ’ãƒ³ãƒˆ: **å››å­—ç†Ÿèª** (å¸¸ã«4æ–‡å­—)</div>
              <div id="hint" class="hint"></div>
            </div>
            </div>

          <div class="word-area" aria-live="polite">
            <div class="picked-label">é¸æŠæ¸ˆã¿ã®æ–‡å­—ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å–ã‚Šæ¶ˆã—ï¼‰</div>
            <div id="picked" class="picked answer-area" aria-label="é¸æŠæ¸ˆã¿ã®æ–‡å­—"></div>

            <div style="margin-top:15px">
              <div class="small-muted">æ–‡å­—ãƒ—ãƒ¼ãƒ«ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠï¼‰</div>
              <div id="pool" class="pool" aria-label="æ–‡å­—ãƒ—ãƒ¼ãƒ«"></div>
            </div>
          </div>

          <div style="margin-top:20px;display:flex;gap:8px;align-items:center;justify-content:space-between">
            <div class="small-muted">ã‚¹ã‚³ã‚¢ï¼š<span id="score">0</span>ï¼æ­£è§£ï¼š<span id="correctCount">0</span></div>
            <div class="small-muted">æ­£ç­”ç‡ï¼š<span id="rate">0%</span></div>
          </div>

          <div id="result" style="display:none;" class="result"></div>
        </div>
      </section>

      <aside class="side">
        <div class="card stat">
          <div>
            <div class="small-muted">æ®‹ã‚Šæ™‚é–“</div>
            <div class="big timer" id="timer">--</div>
          </div>
          <div>
            <div class="small-muted">é€²æ—</div>
            <div class="big" id="progress">0 / 0</div>
          </div>
        </div>
        
        <div class="card">
          <div class="small-muted">ã‚¿ã‚¤ãƒ ãƒ¢ãƒ¼ãƒ‰è¨­å®š</div>
          <div style="margin-top:8px;display:flex;align-items:center;justify-content:space-between;">
             <label class="switch"><input type="checkbox" id="timeToggle"> **ã‚¿ã‚¤ãƒãƒ¼ã‚’æœ‰åŠ¹åŒ–**</label>
             <div>
              <div class="small-muted" style="text-align:right;">åˆ¶é™æ™‚é–“ï¼ˆç§’ï¼‰</div>
              <input id="timeLimit" type="number" value="30" min="5" max="300">
             </div>
          </div>
        </div>

        <div class="card">
          <div class="small-muted">æ“ä½œãƒ‘ãƒãƒ«</div>
          <div style="margin-top:10px" class="footer-actions">
            <button class="btn" id="restartBtn">ã‚²ãƒ¼ãƒ ã‚’æœ€åˆã‹ã‚‰</button>
            <button class="btn" id="randomBtn">ãƒ©ãƒ³ãƒ€ãƒ ãªå•é¡Œã¸</button>
            <button class="btn" id="downloadBtn">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
          </div>
          <div style="margin-top:12px" class="small-muted">â€» ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã® **Enter** ã§åˆ¤å®šã€**Backspace** ã§æœ€å¾Œã®æ–‡å­—ã‚’å–ã‚Šæ¶ˆã—ã§ãã¾ã™ã€‚</div>
        </div>
      </aside>
    </main>

    <footer>å››å­—ç†Ÿèª æ–‡å­—ä¸¦ã¹ã‹ãˆè„³ãƒˆãƒ¬ (è‡ªå‹•æ¬¡ã¸æ©Ÿèƒ½ä»˜ã)</footer>
  </div>

<script>
/* ========== å››å­—ç†Ÿèªãƒªã‚¹ãƒˆ (ç´„100èª) ========== */
const words = [
"ä¸€çŸ³äºŒé³¥","ä¸€æœŸä¸€ä¼š","é¦¬è€³æ±é¢¨","ç”»ç«œç‚¹ç›","è‡¥è–ªå˜—èƒ†","å±æ©Ÿä¸€é«ª","èµ·æ‰¿è»¢çµ","äº”é‡Œéœ§ä¸­","å†ä¸‰å†å››","ä¸‰å¯’å››æ¸©",
"è‡ªçµ¦è‡ªè¶³","ä¸ƒè»¢å…«å€’","ç¸¦æ¨ªç„¡å°½","åäººåè‰²","å¿ƒæ©Ÿä¸€è»¢","æ™´è€•é›¨èª­","åƒå·®ä¸‡åˆ¥","å‰µæ„å·¥å¤«","å¤§å™¨æ™©æˆ","å˜åˆ€ç›´å…¥",
"æœä¸‰æš®å››","å¾¹é ­å¾¹å°¾","é›»å…‰çŸ³ç«","å¤©å¤‰åœ°ç•°","æ±å¥”è¥¿èµ°","ç‹¬ç«‹ç‹¬æ­©","é›£æ”»ä¸è½","æ—¥é€²æœˆæ­©","ç ´é¡”ä¸€ç¬‘","ç™¾æˆ¦éŒ¬ç£¨",
"æ™®éçš„","ä¸è€ä¸æ­»","æ–‡å¥ãªã—","å„ªæŸ”ä¸æ–­","æ²¹æ–­å¤§æ•µ","è‡¨æ©Ÿå¿œå¤‰","å’Œæ´‹æŠ˜è¡·","æ¸©æ•…çŸ¥æ–°","ç•°å£åŒéŸ³","ä»¥å¿ƒä¼å¿ƒ",
"å› æœå¿œå ±","ä¸€æ„å°‚å¿ƒ","ä¸€å¿µç™ºèµ·","å††è»¢æ»‘è„±","æˆ‘ç”°å¼•æ°´","èŠ±é³¥é¢¨æœˆ","å®Œå…¨ç„¡æ¬ ","å¥‡æƒ³å¤©å¤–","ç©ºå‰çµ¶å¾Œ","æœˆä¸‹æ°·äºº",
"é¶é³´ç‹—ç›—","ç‰½å¼·ä»˜ä¼š","å…‰é™°çŸ¢ã®å¦‚ã—","åƒè¼‰ä¸€é‡","æ³°ç„¶è‡ªè‹¥","å¤šå²äº¡ç¾Š","å¤§è¨€å£®èª","çŒªçªçŒ›é€²","ç²’ã€…è¾›è‹¦","å¾’æ‰‹ç©ºæ‹³",
"ç‹¬ç«‹è‡ªå°Š","æœä»¤æš®æ”¹","äºŒæŸä¸‰æ–‡","åšè¦§å¼·è¨˜","ç™¾èŠ±ç¹šä¹±","ä¸è¨€å®Ÿè¡Œ","æœ¬æœ«è»¢å€’","ç„¡ç—…æ¯ç½","æ˜é¡æ­¢æ°´","æœ‰çµ‚ã®ç¾",
"å„ªæŸ”ä¸æ–­","ç«œé ­è›‡å°¾","æ‚ªæˆ¦è‹¦é—˜","æ„æ°—æšã€…","ä¸€ç¶²æ‰“å°½","æˆ‘æ…¢å¼·ã—","é©šå¤©å‹•åœ°","å·§è¨€ä»¤è‰²","å­¤ç«‹ç„¡æ´","è‡ªæ¥­è‡ªå¾—",
"å¼±è‚‰å¼·é£Ÿ","é †é¢¨æº€å¸†","å…ˆæ‰‹å¿…å‹","çµ¶ä½“çµ¶å‘½","é©æé©æ‰€","å½“æ„å³å¦™","é›£è¡Œè‹¦è¡Œ","ç ´ç«¹ã®å‹¢ã„","ç™¾èã¯ä¸€è¦‹ã«ã—ã‹ãš","é¢¨æ—ç«å±±",
"é¢ç›®èºå¦‚","å…«æ–¹ç¾äºº","æœ‰è¨€å®Ÿè¡Œ","è€è‹¥ç”·å¥³","å’Œæ°—è—¹ã€…","ç„¡å‘³ä¹¾ç‡¥","ç•°æ–‡åŒ–äº¤æµ","æš—ä¸­æ¨¡ç´¢","ä¸€æ•—åœ°ã«å¡—ã‚‹","æµ·åƒå±±åƒ"
];

let totalProblems = words.length; // 100
let order = []; // å•é¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é †
let currentIndex = 0;
let currentWord = "";
let poolChars = []; // æ–‡å­—ãƒ—ãƒ¼ãƒ«ï¼ˆå„è¦ç´ ã¯ {ch, idx, used}ï¼‰
let picked = []; // é¸æŠæ¸ˆã¿ï¼ˆãƒ—ãƒ¼ãƒ«ã® idx å‚ç…§ï¼‰
let score = 0;
let correctCount = 0;
let timerId = null;
let timeLeft = 0;
const ANSWER_DELAY_MS = 800; // æ­£è§£æ™‚ã®è‡ªå‹•é·ç§»ã¾ã§ã®é…å»¶æ™‚é–“

// --- UI è¦ç´  ---
const poolEl = document.getElementById('pool');
const pickedEl = document.getElementById('picked');
const qIndexEl = document.getElementById('q-index');
const hintEl = document.getElementById('hint');
const resultEl = document.getElementById('result');
const scoreEl = document.getElementById('score');
const correctEl = document.getElementById('correctCount');
const rateEl = document.getElementById('rate');
const timerEl = document.getElementById('timer');
const progressEl = document.getElementById('progress');
const shuffleBtn = document.getElementById('shuffleBtn');
const showAnswerBtn = document.getElementById('showAnswerBtn');
const resetBtn = document.getElementById('resetBtn');
const checkBtn = document.getElementById('checkBtn');
const nextBtn = document.getElementById('nextBtn');
const restartBtn = document.getElementById('restartBtn');
const randomBtn = document.getElementById('randomBtn');
const downloadBtn = document.getElementById('downloadBtn');
const timeToggle = document.getElementById('timeToggle');
const timeLimitInput = document.getElementById('timeLimit');

// Utility: ã‚·ãƒ£ãƒƒãƒ•ãƒ«
function shuffleArray(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

// åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼šå•é¡Œé †ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
function setupOrder(){
  order = Array.from({length: totalProblems}, (_,i)=>i);
  shuffleArray(order);
  currentIndex = 0;
}

// å•é¡Œã‚»ãƒƒãƒˆ
function setProblem(indexInOrder){
  clearResult();
  picked = [];
  poolChars = [];

  const idx = order[indexInOrder];
  currentWord = words[idx];
  const chars = Array.from(currentWord);

  // æ¼¢å­—ã®æœ‰ç„¡ãƒ’ãƒ³ãƒˆã‚’å…·ä½“åŒ–
  hintEl.textContent = `ã“ã®å››å­—ç†Ÿèªã®ãƒ†ãƒ¼ãƒ: ${generateHint(currentWord)}`;
  qIndexEl.textContent = `å•é¡Œ ${indexInOrder+1} / ${totalProblems}`;
  progressEl.textContent = `${indexInOrder+1} / ${totalProblems}`;

  // ãƒ—ãƒ¼ãƒ«ã‚’ä½œã‚‹
  const charsCopy = chars.slice();
  shuffleArray(charsCopy);
  poolChars = charsCopy.map((ch,i)=>({ch, idx:i, used:false}));
  
  renderPool();
  renderPicked();
  updateStats();
  resetTimerIfNeeded();
}

// ãƒ’ãƒ³ãƒˆç”Ÿæˆï¼ˆä»Šå›ã¯å››å­—ç†Ÿèªãªã®ã§ãƒ†ãƒ¼ãƒçš„ãªãƒ’ãƒ³ãƒˆã‚’å‡ºã™ï¼‰
function generateHint(word){
    // æœ€åˆã®1æ–‡å­—ã¨æœ€å¾Œã®1æ–‡å­—ã‚’ãƒ’ãƒ³ãƒˆã¨ã—ã¦å‡ºã™
    const chars = Array.from(word);
    if (chars.length === 4) {
        return `ã€Œ${chars[0]}ã€‡ã€‡${chars[3]}ã€`;
    }
    return `å››å­—ç†Ÿèª (${chars.length}æ–‡å­—)`;
}

// ãƒ—ãƒ¼ãƒ«æç”»
function renderPool(){
  poolEl.innerHTML = "";
  poolChars.forEach((item, i) => {
    const b = document.createElement('button');
    b.className = 'char' + (item.used ? ' disabled' : '');
    b.textContent = item.ch;
    b.setAttribute('data-i', i);
    b.title = item.used ? 'é¸æŠæ¸ˆã¿' : 'ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ';
    if(!item.used){
      b.addEventListener('click', () => {
        selectChar(i);
      });
    } else {
      b.addEventListener('click', ()=>{});
    }
    poolEl.appendChild(b);
  });
}

// é¸æŠæ¸ˆã¿è¡¨ç¤º
function renderPicked(){
  pickedEl.innerHTML = "";
  picked.forEach((poolIdx, pos) => {
    const span = document.createElement('button');
    span.className = 'char';
    span.textContent = poolChars[poolIdx].ch;
    span.title = 'å–ã‚Šæ¶ˆã™ï¼šã‚¯ãƒªãƒƒã‚¯ã§æˆ»ã™';
    span.addEventListener('click', () => {
      unselectChar(pos);
    });
    pickedEl.appendChild(span);
  });

  // è‡ªå‹•åˆ¤å®šã®ãƒ­ã‚¸ãƒƒã‚¯
  if(currentWord && picked.length === Array.from(currentWord).length){
    checkAnswer(true); // å…¨ã¦ã®æ–‡å­—ãŒé¸æŠã•ã‚ŒãŸã‚‰è‡ªå‹•åˆ¤å®š
  }
}

// æ–‡å­—ã‚’é¸ã¶
function selectChar(poolIdx){
  if(poolChars[poolIdx].used) return;
  poolChars[poolIdx].used = true;
  picked.push(poolIdx);
  renderPool();
  renderPicked();
  clearResult();
}

// é¸æŠã‚’å–ã‚Šæ¶ˆã™ï¼ˆpicked ã® pos ã‚’æŒ‡å®šï¼‰
function unselectChar(pickedPos){
  const poolIdx = picked.splice(pickedPos,1)[0];
  poolChars[poolIdx].used = false;
  renderPool();
  renderPicked();
  clearResult();
}

// ç¾åœ¨ã®é¸æŠæ–‡å­—åˆ—å–å¾—
function currentAnswer(){
  return picked.map(i => poolChars[i].ch).join('');
}

// åˆ¤å®š (autoCheckãŒtrueã®æ™‚ã¯è‡ªå‹•ã§æ¬¡ã¸)
function checkAnswer(autoCheck = false){
  const ans = currentAnswer();
  if(ans.length === 0){
    showResult('ä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'ng', 'âš ï¸');
    return;
  }
  if(ans === currentWord){
    // æ­£è§£
    score += currentWord.length * 2; // 4æ–‡å­—ç†Ÿèªãªã®ã§ãƒœãƒ¼ãƒŠã‚¹
    correctCount++;
    showResult(`âœ¨æ­£è§£ï¼ã€Œ${currentWord}ã€`, 'ok', 'âœ…');
    updateStats();
    stopTimer();
    
    // è‡ªå‹•æ¬¡ã¸æ©Ÿèƒ½
    if(autoCheck){
        setTimeout(()=>{ nextProblem(); }, ANSWER_DELAY_MS);
    }
  } else {
    showResult(`âŒä¸æ­£è§£â€¦ï¼ˆã‚ãªãŸã®è§£ç­”: ${ans}ï¼‰`, 'ng', 'âŒ');
  }
}

// çµæœè¡¨ç¤º
function showResult(text, kind, icon){
  resultEl.style.display = 'flex';
  resultEl.className = 'result ' + (kind === 'ok' ? 'ok' : 'ng');
  resultEl.innerHTML = `<span class="result-icon">${icon}</span> ${text}`;
}

// ã‚¯ãƒªã‚¢çµæœ
function clearResult(){
  resultEl.style.display = 'none';
  resultEl.innerHTML = '';
  resultEl.className = 'result';
}

// æ¬¡ã®å•é¡Œã¸
function nextProblem(){
  if(currentIndex < totalProblems - 1){
    currentIndex++;
    setProblem(currentIndex);
  } else {
    alert('å…¨å•çµ‚äº†ã—ã¾ã—ãŸï¼æœ€åˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å†é–‹ã—ã¾ã™ã€‚');
    setupOrder();
    setProblem(currentIndex = 0);
  }
  clearTimer();
  updateStats();
}

// ãƒªã‚»ãƒƒãƒˆï¼ˆé¸æŠè§£é™¤ï¼‰
function resetSelection(){
  picked.forEach(i => poolChars[i].used = false);
  picked = [];
  renderPool();
  renderPicked();
  clearResult();
}

// ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒ—ãƒ¼ãƒ«
function shufflePool(){
  const unused = poolChars.filter(p => !p.used).map(p => p.ch);
  shuffleArray(unused);

  let uIndex = 0;
  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç¶­æŒã—ã¤ã¤æ–‡å­—ã ã‘ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  const newPoolChars = poolChars.map(p => {
    if(!p.used){
      p.ch = unused[uIndex++];
    }
    return p;
  });
  poolChars = newPoolChars;
  renderPool();
}

// ç­”ãˆè¡¨ç¤º
function showAnswer(){
  resetSelection();
  const chars = Array.from(currentWord);
  // æ­£ã—ã„ä¸¦ã³ã§ãƒ—ãƒ¼ãƒ«ã‚’å†æ§‹ç¯‰ã—ã€ã™ã¹ã¦é¸æŠæ¸ˆã¿ã«ã™ã‚‹
  poolChars = chars.map((ch,i)=>({ch, idx:i, used: true}));
  picked = poolChars.map((_,i)=>i);
  renderPool();
  renderPicked();
  showResult(`ğŸ’¡ç­”ãˆï¼š${currentWord}`, 'ok', 'ğŸ’¡');
  stopTimer();
  updateStats();
}

// ã‚¹ã‚³ã‚¢ç­‰ã®æ›´æ–°
function updateStats(){
  scoreEl.textContent = score;
  correctEl.textContent = correctCount;
  const rate = (correctCount === 0) ?
  0 : Math.round((correctCount / (currentIndex+1)) * 100);
  rateEl.textContent = rate + '%';
  progressEl.textContent = `${currentIndex+1} / ${totalProblems}`;
}

// ãƒ©ãƒ³ãƒ€ãƒ ã«ä»Šã™ãæ¬¡ã®å•é¡Œ
function jumpRandomProblem(){
  currentIndex = Math.floor(Math.random() * totalProblems);
  setProblem(currentIndex);
  clearTimer();
}

// å†ã‚¹ã‚¿ãƒ¼ãƒˆ
function restartGame(){
  score = 0;
  correctCount = 0;
  setupOrder();
  setProblem(0);
  updateStats();
  clearTimer();
}

// çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
function downloadResult(){
  const text = `å››å­—ç†Ÿèª ä¸¦ã¹ã‹ãˆ çµæœ\né€²æ—: ${currentIndex+1}/${totalProblems}\nã‚¹ã‚³ã‚¢: ${score}\næ­£è§£æ•°: ${correctCount}\næ­£ç­”ç‡: ${rateEl.textContent}\nç¾åœ¨ã®å˜èª: ${currentWord}\n`;
  navigator.clipboard?.writeText(text).then(()=>{
    alert('çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
  }, ()=>{
    alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
  });
}

/* ===== ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ ===== */
function resetTimerIfNeeded(){
  stopTimer();
  if(timeToggle.checked){
    const limit = Number(timeLimitInput.value) || 30;
    timeLeft = limit;
    timerEl.textContent = `${timeLeft}s`;
    startTimer();
  } else {
    timerEl.textContent = '--';
  }
}
function startTimer(){
  if(!timeToggle.checked) return;
  stopTimer();
  timerEl.textContent = `${timeLeft}s`;
  timerEl.style.color = timeLeft <= 10 ? 'var(--ng)' : '#1f2937';
  timerId = setInterval(()=>{
    timeLeft--;
    timerEl.textContent = `${timeLeft}s`;
    timerEl.style.color = timeLeft <= 10 ? 'var(--ng)' : '#1f2937';
    if(timeLeft <= 0){
      clearInterval(timerId);
      timerId = null;
      // æ™‚é–“åˆ‡ã‚Œï¼šè‡ªå‹•ã§ä¸æ­£è§£æ‰±ã„ã—ã¦æ¬¡ã¸
      showResult('â°æ™‚é–“åˆ‡ã‚Œï¼æ¬¡ã®å•é¡Œã¸é€²ã¿ã¾ã™', 'ng', 'â³');
      setTimeout(()=>{ nextProblem(); }, ANSWER_DELAY_MS);
    }
  }, 1000);
}
function stopTimer(){
  if(timerId){ clearInterval(timerId); timerId = null; }
}
function clearTimer(){
  stopTimer();
  timerEl.textContent = '--';
  timerEl.style.color = '#1f2937';
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² ===== */
shuffleBtn.addEventListener('click', shufflePool);

showAnswerBtn.addEventListener('click', () => {
  if(confirm('æœ¬å½“ã«ç­”ãˆã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ ç­”ãˆã‚’è¦‹ãŸå ´åˆã€ã“ã®å•é¡Œã®ã‚¹ã‚³ã‚¢ã¯ã¤ãã¾ã›ã‚“ã€‚')) {
    showAnswer();
  }
});
resetBtn.addEventListener('click', resetSelection);

// æ‰‹å‹•åˆ¤å®šãƒœã‚¿ãƒ³ã‚‚è‡ªå‹•åˆ¤å®šã‚’å‘¼ã¶
checkBtn.addEventListener('click', () => {
  checkAnswer(true); 
}); 

nextBtn.addEventListener('click', nextProblem);

restartBtn.addEventListener('click', () => {
  if(confirm('ã‚²ãƒ¼ãƒ ã‚’æœ€åˆã‹ã‚‰å†ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ ã‚¹ã‚³ã‚¢ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚')) restartGame();
});
randomBtn.addEventListener('click', jumpRandomProblem);
downloadBtn.addEventListener('click', downloadResult);
timeToggle.addEventListener('change', resetTimerIfNeeded);
timeLimitInput.addEventListener('change', () => {
  const limit = Number(timeLimitInput.value);
  if(limit < 5) timeLimitInput.value = 5;
  resetTimerIfNeeded();
});

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œï¼šEnterã§åˆ¤å®šã€Backspaceã§å–ã‚Šæ¶ˆã—
document.addEventListener('keydown', (e) => {
  if(e.key === 'Enter') {
    e.preventDefault();
    checkAnswer(true); // Enterã§ã‚‚è‡ªå‹•æ¬¡ã¸
  } else if(e.key === 'Backspace') {
    e.preventDefault();
    if(picked.length>0) unselectChar(picked.length - 1);
  }
});

/* åˆæœŸåŒ– */
function init(){
  setupOrder();
  setProblem(0);
  updateStats();
}

init();

</script>
</body>
</html>
