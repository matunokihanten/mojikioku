<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>数字記憶ゲーム</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
/* 基本スタイルとリセット */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  /* タップ時のハイライトを無効化 */
  -webkit-tap-highlight-color: transparent;
}

html, body {
  height: 100%;
  overflow: hidden; /* ページ全体のスクロールを禁止 */
}

body {
  background: #e8f0f4;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  color: #333;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* ゲーム全体のコンテナ */
.container {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  padding: 10px;
  width: 100%;
  max-width: 400px; /* スマートフォン向けに幅を調整 */
  margin: auto;
  display: flex;
  flex-direction: column;
  /* アドレスバーなどを考慮した画面高さに追従 */
  height: 100vh;
  height: 100dvh; 
}

/* 上部の設定バー */
.settings-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px 0;
  border-bottom: 1px solid #eee;
  flex-shrink: 0; /* このエリアの高さを固定 */
}

.settings-bar h1 {
  font-size: 1.2em;
  color: #006d77;
  margin-right: 10px;
}

.settings-bar label {
  font-size: 0.9em;
  margin-right: 5px;
}

.settings-bar select {
  padding: 4px 8px;
  border: 1px solid #bbb;
  border-radius: 6px;
  font-size: 0.9em;
}

.settings-bar button {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: #83c5be;
  color: white;
  font-weight: bold;
  transition: background 0.2s ease;
  font-size: 0.9em;
  margin-left: auto;
}

.settings-bar button:hover {
  background: #5aa399;
}

/* ゲーム要素のスタイル */
#instruction {
  font-size: 1.2em;
  margin: 5px 0;
  font-weight: bold;
  text-align: center;
  flex-shrink: 0;
}

#numberDisplay {
  font-size: 2.8em;
  font-weight: bold;
  color: #006d77;
  min-height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

#prompt {
  font-size: 0.9em;
  margin-bottom: 5px;
  text-align: center;
  min-height: 1.2em;
  flex-shrink: 0;
}

#userInput {
  font-size: 1.5em;
  padding: 5px;
  width: 70%;
  margin: 0 auto 5px auto;
  text-align: center;
  border: 1px solid #aaa;
  border-radius: 6px;
  background-color: #f9f9f9;
  flex-shrink: 0;
}

#status {
  font-size: 1em;
  margin-bottom: 5px;
  text-align: center;
  min-height: 1.2em;
  font-weight: bold;
  flex-shrink: 0;
}

/* 履歴表示エリア - 残りのスペースを全て使用 */
#historyContainer {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
  grid-gap: 4px;
  padding: 5px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #fafafa;
  flex: 1; /* ★ この設定でレイアウトの主役になります */
  overflow-y: auto; /* 内容が増えたらスクロール */
}

.history-number {
  font-size: 0.9em;
  font-weight: bold;
  padding: 4px;
  border: 1px solid #ccc;
  border-radius: 4px;
  text-align: center;
}

.history-number.correct { background: #d4edda; color: #155724; }
.history-number.incorrect { background: #f8d7da; color: #721c24; }

/* キーパッド */
#keypad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-gap: 5px;
  width: 100%;
  max-width: 280px;
  margin: 10px auto;
  flex-shrink: 0;
}

#keypad button {
  background: #edf6f9;
  color: #333;
  font-size: 1.5em;
  font-weight: bold;
  padding: 10px 0;
  border: 1px solid #bbb;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s ease;
}

#keypad button:hover {
  background: #dcefee;
}

#keypad button.clear-button { background: #ffddd2; }
#keypad button.clear-button:hover { background: #ffc2b2; }

/* 下部のボタン */
#gameButtons {
  display: flex;
  justify-content: center;
  padding: 5px 0;
  flex-shrink: 0;
}

#showAnswerButton {
  width: 80%;
  max-width: 280px;
  padding: 8px;
  font-size: 1em;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: #e5989b;
  color: white;
  font-weight: bold;
  transition: background 0.2s ease;
}

#showAnswerButton:hover {
  background: #d96e71;
}

</style>
</head>
<body>

<div class="container">
  <div class="settings-bar">
    <h1>数字記憶</h1>
    <div>
      <label for="digitSelect">桁数:</label>
      <select id="digitSelect">
        <option value="2">2桁</option>
        <option value="3">3桁</option>
        <option value="4">4桁</option>
        <option value="5">5桁</option>
      </select>
    </div>
    <button id="startButton">開始</button>
  </div>

  <div id="instruction">数字を覚えてね</div>
  <div id="numberDisplay">&nbsp;</div>
  <div id="prompt"></div>
  <input type="text" id="userInput" readonly placeholder="入力">
  <div id="status"></div>
  <div id="historyContainer"></div>
  <div id="keypad"></div>
  <div id="gameButtons">
    <button id="showAnswerButton">答えを見る</button>
  </div>
</div>

<script>
// DOM要素の取得
const digitSelect = document.getElementById("digitSelect");
const startButton = document.getElementById("startButton");
const showAnswerButton = document.getElementById("showAnswerButton");
const instructionElem = document.getElementById("instruction");
const numberDisplayElem = document.getElementById("numberDisplay");
const promptElem = document.getElementById("prompt");
const userInputElem = document.getElementById("userInput");
const statusElem = document.getElementById("status");
const historyContainer = document.getElementById("historyContainer");
const keypad = document.getElementById("keypad");

// ゲームの状態を管理する変数
let digitCount = 2;
let round = 1;
let prevNumber = "";
let currentNumber = "";
let allowInput = false;
let answerRevealed = false;
let isGameActive = false;
let gameTimeout; // setTimeoutのIDを保持

// イベントリスナーの設定
startButton.addEventListener("click", toggleGame);
showAnswerButton.addEventListener("click", showAnswer);

// 初期設定
createKeypad();
resetUI(); // 初期UI状態を設定

/**
 * ゲームの開始とリセットを切り替える関数
 */
function toggleGame() {
    if (isGameActive) {
        if (confirm("現在のゲームを終了してリセットしますか？")) {
            resetGame();
        }
    } else {
        startGame();
    }
}

/**
 * ゲームを開始する関数
 */
function startGame() {
    isGameActive = true;
    startButton.textContent = "リセット";
    digitSelect.disabled = true; // ゲーム中は桁数変更を不可に

    digitCount = parseInt(digitSelect.value, 10);
    round = 1;
    prevNumber = "";
    currentNumber = "";
    allowInput = false;
    answerRevealed = false;

    historyContainer.innerHTML = "";
    userInputElem.value = "";
    statusElem.textContent = "";

    startRound();
}

/**
 * ゲームをリセットし、初期状態に戻す関数
 */
function resetGame() {
    clearTimeout(gameTimeout); // 進行中のタイマーをクリア
    isGameActive = false;
    resetUI();
}

/**
 * UIをゲーム開始前の状態に戻す関数
 */
function resetUI() {
    startButton.textContent = "開始";
    digitSelect.disabled = false;
    instructionElem.textContent = "桁数を選んで「開始」を押してね";
    numberDisplayElem.innerHTML = "&nbsp;";
    promptElem.textContent = "";
    userInputElem.value = "";
    statusElem.textContent = "";
    historyContainer.innerHTML = "";
    allowInput = false;
}

/**
 * 「答えを見る」ボタンの処理
 */
function showAnswer() {
    if (!allowInput || !isGameActive) return;
    answerRevealed = true;
    statusElem.textContent = "答え: " + prevNumber;
    statusElem.style.color = "#006600";
}

/**
 * 数字キーパッドを生成する関数
 */
function createKeypad() {
    keypad.innerHTML = "";
    // 1-9のボタン
    for (let num = 1; num <= 9; num++) {
        const btn = document.createElement("button");
        btn.textContent = num;
        btn.addEventListener("click", () => appendDigit(num));
        keypad.appendChild(btn);
    }
    // クリアボタン
    const clearBtn = document.createElement("button");
    clearBtn.textContent = "C";
    clearBtn.className = "clear-button";
    clearBtn.addEventListener("click", clearInput);
    keypad.appendChild(clearBtn);
    // 0のボタン
    const btn0 = document.createElement("button");
    btn0.textContent = "0";
    btn0.addEventListener("click", () => appendDigit(0));
    keypad.appendChild(btn0);
    // ダミーのボタン（レイアウト調整用）
    const dummyBtn = document.createElement("button");
    dummyBtn.style.visibility = "hidden";
    keypad.appendChild(dummyBtn);
}

/**
 * 指定された桁数のランダムな数値を生成する関数
 * @param {number} digits - 生成する数値の桁数
 * @returns {string} ランダムな数値の文字列
 */
function generateRandomNumber(digits) {
    if (digits < 1) return "0";
    const min = Math.pow(10, digits - 1);
    const max = Math.pow(10, digits) - 1;
    return String(Math.floor(Math.random() * (max - min + 1)) + min);
}

/**
 * 新しいラウンドを開始する関数
 */
function startRound() {
    if (!isGameActive) return;

    statusElem.textContent = "";
    promptElem.textContent = "";
    userInputElem.value = "";
    allowInput = false;
    answerRevealed = false;

    currentNumber = generateRandomNumber(digitCount);

    instructionElem.textContent = (round === 1) ? "最初の数字を覚えてね" : "次の数字を覚えて…";
    numberDisplayElem.textContent = currentNumber;

    // 3秒間数字を表示
    gameTimeout = setTimeout(() => {
        if (!isGameActive) return;
        numberDisplayElem.innerHTML = "&nbsp;";
        
        if (round === 1) {
            // 最初のラウンドは覚えるだけ
            prevNumber = currentNumber;
            round++;
            startRound(); // すぐに次のラウンドへ
        } else {
            // 2ラウンド目以降は入力フェーズへ
            allowInput = true;
            instructionElem.textContent = "【直前の数字】を入力！";
            promptElem.textContent = `(今覚える数字: ${currentNumber})`;
        }
    }, 3000);
}

/**
 * ユーザー入力に数字を追加する関数
 * @param {number} digit - 入力された数字
 */
function appendDigit(digit) {
    if (!allowInput || !isGameActive) return;
    if (answerRevealed) {
        statusElem.textContent = "";
        answerRevealed = false;
    }
    
    if (userInputElem.value.length < digitCount) {
        userInputElem.value += digit.toString();
    }
    
    // 入力が完了したら自動で答えをチェック
    if (userInputElem.value.length === digitCount) {
        gameTimeout = setTimeout(checkAnswer, 200);
    }
}

/**
 * 入力欄をクリアする関数
 */
function clearInput() {
    if (!allowInput || !isGameActive) return;
    userInputElem.value = "";
    statusElem.textContent = "";
    answerRevealed = false;
}

/**
 * 答えをチェックする関数
 */
function checkAnswer() {
    if (!isGameActive) return;
    allowInput = false; // チェック中は入力を禁止

    if (userInputElem.value === prevNumber) {
        statusElem.textContent = "正解！🎉";
        statusElem.style.color = "#006600";
        addToHistory(prevNumber, true);
    } else {
        statusElem.textContent = "不正解… 正解は " + prevNumber;
        statusElem.style.color = "#cc0000";
        addToHistory(prevNumber, false);
    }
    
    // 次のラウンドの準備
    prevNumber = currentNumber;
    round++;

    // 1.5秒後に次のラウンドへ
    gameTimeout = setTimeout(() => {
        if (!isGameActive) return;
        startRound();
    }, 1500);
}

/**
 * 結果を履歴に追加する関数
 * @param {string} num - 対象の数字
 * @param {boolean} isCorrect - 正解かどうか
 */
function addToHistory(num, isCorrect) {
    const span = document.createElement("span");
    span.textContent = num;
    span.className = "history-number";
    span.classList.add(isCorrect ? "correct" : "incorrect");
    historyContainer.appendChild(span);
    // 自動で一番下までスクロール
    historyContainer.scrollTop = historyContainer.scrollHeight;
}
</script>
</body>
</html>
