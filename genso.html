<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…ƒç´ è¨˜å·è„³ãƒˆãƒ¬ã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .app-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        /* All screen containers are hidden by default */
        .screen-container { /* Unified class for all screen containers */
            display: none;
        }

        /* Only active screen is displayed */
        .screen-container.active { /* Use 'active' for consistency */
            display: block;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .menu-button, .quiz-button, .back-button {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .menu-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .quiz-button {
            background: #4CAF50;
            color: white;
            margin: 10px;
        }

        .quiz-button:hover {
            background: #45a049;
        }

        .quiz-button.incorrect {
            background: #f44336;
        }

        .quiz-button.correct {
            background: #2196F3;
        }

        .back-button {
            background: #ff7043;
            color: white;
            margin-top: 20px;
        }

        .back-button:hover {
            background: #f4511e;
        }

        .mode-selector {
            margin-bottom: 20px;
        }

        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mode-button {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-button.active {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .mode-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }


        .difficulty-selector {
            margin-bottom: 20px;
        }

        .difficulty-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .difficulty-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .difficulty-btn.active {
            background: #667eea;
            color: white;
        }

        .quiz-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
        }

        .quiz-question {
            text-align: center;
            margin-bottom: 30px;
        }

        .question-text {
            font-size: 1.8em;
            margin-bottom: 15px;
            color: #333;
        }

        .element-display {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(102, 126, 234, 0.1);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .result-message {
            text-align: center;
            margin-bottom: 30px;
        }

        .result-score {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .result-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 20px;
        }

        .feedback {
            text-align: center;
            font-size: 1.1em;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .feedback.correct {
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
        }

        .feedback.incorrect {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        .timer {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .combo-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .combo-number {
            font-size: 2em;
            font-weight: bold;
            color: #ff9800;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .animation-correct {
            animation: bounceIn 0.5s ease;
        }

        .animation-incorrect {
            animation: shake 0.5s ease;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .settings-container {
            margin-bottom: 20px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .leaderboard {
            margin-top: 20px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
        }

        .rank {
            font-weight: bold;
            color: #667eea;
        }

        /* Periodic Table specific styles */
        .element-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Adjust column width as needed */
            gap: 10px;
            max-height: 400px; /* Make it scrollable if too long */
            overflow-y: auto;
            padding: 10px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .element-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .element-item:hover {
            transform: translateY(-2px);
        }

        .element-item .symbol {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .element-item .name {
            font-size: 0.9em;
            color: #333;
        }

        .element-item .number {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1 class="title">âš—ï¸ å…ƒç´ è¨˜å·ãƒã‚¹ã‚¿ãƒ¼</h1>
            <p class="subtitle">æ¥½ã—ãå­¦ã¶åŒ–å­¦ã®åŸºç¤</p>
        </div>

        <div id="menuScreen" class="screen-container active">
            <div class="menu-buttons">
                <button class="menu-button" onclick="showModeSelector()">ğŸ¯ ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                <button class="menu-button" onclick="showPeriodicTable()">ğŸ“– å…ƒç´ è¨˜å·è¡¨</button>
                <button class="menu-button" onclick="showStats()">ğŸ“Š å­¦ç¿’çµ±è¨ˆ</button>
                <button class="menu-button" onclick="showSettings()">âš™ï¸ è¨­å®š</button>
                <button class="menu-button" onclick="showLeaderboard()">ğŸ† ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰</button>
            </div>
        </div>

        <div id="modeSelector" class="screen-container">
            <h3 style="text-align: center; margin-bottom: 20px;">ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
            <div class="mode-buttons">
                <button class="mode-button" onclick="selectMode('normal', event)">ğŸ“ é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</button>
                <button class="mode-button" onclick="selectMode('weakness', event)">ğŸ’ª è‹¦æ‰‹å…‹æœãƒ¢ãƒ¼ãƒ‰</button>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="quiz-button" onclick="showDifficultySelector()">æ¬¡ã¸</button>
                <button class="back-button" onclick="showMenu()">æˆ»ã‚‹</button>
            </div>
        </div>

        <div id="difficultySelector" class="screen-container">
            <h3 style="text-align: center; margin-bottom: 20px;">é›£æ˜“åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
            <div class="difficulty-buttons">
                <button class="difficulty-btn" onclick="selectDifficulty('easy', event)">åˆç´š</button>
                <button class="difficulty-btn" onclick="selectDifficulty('medium', event)">ä¸­ç´š</button>
                <button class="difficulty-btn" onclick="selectDifficulty('hard', event)">ä¸Šç´š</button>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="quiz-button" onclick="startQuiz()">ã‚¯ã‚¤ã‚ºé–‹å§‹</button>
                <button class="back-button" onclick="showModeSelector()">æˆ»ã‚‹</button>
            </div>
        </div>

        <div id="quizScreen" class="screen-container">
            <div class="quiz-info">
                <span>å•é¡Œ <span id="questionNumber">1</span> / <span id="totalQuestions">10</span></span>
                <span>ã‚¹ã‚³ã‚¢: <span id="currentScore">0</span></span>
                <span class="timer">æ™‚é–“: <span id="timeLeft">30</span>ç§’</span>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="combo-display" id="comboDisplay" style="display: none;">
                <div>ğŸ”¥ ã‚³ãƒ³ãƒœ <span class="combo-number" id="comboNumber">0</span></div>
            </div>

            <div class="quiz-question">
                <div class="question-text" id="questionText"></div>
                <div class="element-display" id="elementDisplay"></div>
            </div>

            <div class="options" id="optionsContainer"></div>

            <div class="feedback" id="feedback"></div>

            <button class="back-button" onclick="showMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
        </div>

        <div id="resultScreen" class="screen-container">
            <div class="result-message">
                <div class="result-score" id="finalScore">0</div>
                <div class="result-text" id="resultText"></div>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="correctCount">0</div>
                    <div class="stat-label">æ­£è§£æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="accuracyRate">0%</div>
                    <div class="stat-label">æ­£ç­”ç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="maxCombo">0</div>
                    <div class="stat-label">æœ€å¤§ã‚³ãƒ³ãƒœ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgTime">0s</div>
                    <div class="stat-label">å¹³å‡å›ç­”æ™‚é–“</div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="quiz-button" onclick="showModeSelector()">ã‚‚ã†ä¸€åº¦</button>
                <button class="back-button" onclick="showMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
            </div>
        </div>

        <div id="statsScreen" class="screen-container">
            <h3 style="text-align: center; margin-bottom: 20px;">ğŸ“Š å­¦ç¿’çµ±è¨ˆ</h3>
            <div class="stats-container" id="statsContainer"></div>
            <button class="back-button" onclick="showMenu()">æˆ»ã‚‹</button>
        </div>

        <div id="settingsScreen" class="screen-container">
            <h3 style="text-align: center; margin-bottom: 20px;">âš™ï¸ è¨­å®š</h3>
            <div class="settings-container">
                <div class="setting-item">
                    <span>éŸ³éŸ¿åŠ¹æœ</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="soundToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span>ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="timerToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span>ã‚³ãƒ³ãƒœè¡¨ç¤º</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="comboToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <button class="back-button" onclick="showMenu()">æˆ»ã‚‹</button>
        </div>

        <div id="leaderboardScreen" class="screen-container">
            <h3 style="text-align: center; margin-bottom: 20px;">ğŸ† ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰</h3>
            <div class="leaderboard" id="leaderboardContainer"></div>
            <button class="back-button" onclick="showMenu()">æˆ»ã‚‹</button>
        </div>

        <div id="periodicTableScreen" class="screen-container">
            <h3 style="text-align: center; margin-bottom: 20px;">ğŸ“– å…ƒç´ è¨˜å·ä¸€è¦§</h3>
            <div class="element-list" id="elementListContainer">
                </div>
            <button class="back-button" onclick="showMenu()">æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // å…ƒç´ ãƒ‡ãƒ¼ã‚¿ï¼ˆé›£æ˜“åº¦åˆ¥ï¼‰
        const elements = {
            easy: [
                { name: "æ°´ç´ ", symbol: "H", number: 1 },
                { name: "ãƒ˜ãƒªã‚¦ãƒ ", symbol: "He", number: 2 },
                { name: "ãƒªãƒã‚¦ãƒ ", symbol: "Li", number: 3 },
                { name: "ç‚­ç´ ", symbol: "C", number: 6 },
                { name: "çª’ç´ ", symbol: "N", number: 7 },
                { name: "é…¸ç´ ", symbol: "O", number: 8 },
                { name: "ãƒŠãƒˆãƒªã‚¦ãƒ ", symbol: "Na", number: 11 },
                { name: "ãƒã‚°ãƒã‚·ã‚¦ãƒ ", symbol: "Mg", number: 12 },
                { name: "ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ ", symbol: "Al", number: 13 },
                { name: "ã‚±ã‚¤ç´ ", symbol: "Si", number: 14 },
                { name: "ç¡«é»„", symbol: "S", number: 16 },
                { name: "å¡©ç´ ", symbol: "Cl", number: 17 },
                { name: "ã‚«ãƒªã‚¦ãƒ ", symbol: "K", number: 19 },
                { name: "ã‚«ãƒ«ã‚·ã‚¦ãƒ ", symbol: "Ca", number: 20 },
                { name: "é‰„", symbol: "Fe", number: 26 },
                { name: "éŠ…", symbol: "Cu", number: 29 },
                { name: "äºœé‰›", symbol: "Zn", number: 30 },
                { name: "éŠ€", symbol: "Ag", number: 47 },
                { name: "é‡‘", symbol: "Au", number: 79 }
            ],
            medium: [
                { name: "ãƒ™ãƒªãƒªã‚¦ãƒ ", symbol: "Be", number: 4 },
                { name: "ãƒ›ã‚¦ç´ ", symbol: "B", number: 5 },
                { name: "ãƒ•ãƒƒç´ ", symbol: "F", number: 9 },
                { name: "ãƒã‚ªãƒ³", symbol: "Ne", number: 10 },
                { name: "ãƒªãƒ³", symbol: "P", number: 15 },
                { name: "ã‚¢ãƒ«ã‚´ãƒ³", symbol: "Ar", number: 18 },
                { name: "ã‚¹ã‚«ãƒ³ã‚¸ã‚¦ãƒ ", symbol: "Sc", number: 21 },
                { name: "ãƒã‚¿ãƒ³", symbol: "Ti", number: 22 },
                { name: "ãƒãƒŠã‚¸ã‚¦ãƒ ", symbol: "V", number: 23 },
                { name: "ã‚¯ãƒ­ãƒ ", symbol: "Cr", number: 24 },
                { name: "ãƒãƒ³ã‚¬ãƒ³", symbol: "Mn", number: 25 },
                { name: "ã‚³ãƒãƒ«ãƒˆ", symbol: "Co", number: 27 },
                { name: "ãƒ‹ãƒƒã‚±ãƒ«", symbol: "Ni", number: 28 },
                { name: "ã‚¬ãƒªã‚¦ãƒ ", symbol: "Ga", number: 31 },
                { name: "ã‚²ãƒ«ãƒãƒ‹ã‚¦ãƒ ", symbol: "Ge", number: 32 },
                { name: "ãƒ’ç´ ", symbol: "As", number: 33 },
                { name: "ã‚»ãƒ¬ãƒ³", symbol: "Se", number: 34 },
                { name: "è‡­ç´ ", symbol: "Br", number: 35 },
                { name: "ã‚¯ãƒªãƒ—ãƒˆãƒ³", symbol: "Kr", number: 36 }
            ],
            hard: [
                { name: "ãƒ«ãƒ“ã‚¸ã‚¦ãƒ ", symbol: "Rb", number: 37 },
                { name: "ã‚¹ãƒˆãƒ­ãƒ³ãƒã‚¦ãƒ ", symbol: "Sr", number: 38 },
                { name: "ã‚¤ãƒƒãƒˆãƒªã‚¦ãƒ ", symbol: "Y", number: 39 },
                { name: "ã‚¸ãƒ«ã‚³ãƒ‹ã‚¦ãƒ ", symbol: "Zr", number: 40 },
                { name: "ãƒ‹ã‚ªãƒ–", symbol: "Nb", number: 41 },
                { name: "ãƒ¢ãƒªãƒ–ãƒ‡ãƒ³", symbol: "Mo", number: 42 },
                { name: "ãƒ†ã‚¯ãƒãƒã‚¦ãƒ ", symbol: "Tc", number: 43 },
                { name: "ãƒ«ãƒ†ãƒ‹ã‚¦ãƒ ", symbol: "Ru", number: 44 },
                { name: "ãƒ­ã‚¸ã‚¦ãƒ ", symbol: "Rh", number: 45 },
                { name: "ãƒ‘ãƒ©ã‚¸ã‚¦ãƒ ", symbol: "Pd", number: 46 },
                { name: "ã‚«ãƒ‰ãƒŸã‚¦ãƒ ", symbol: "Cd", number: 48 },
                { name: "ã‚¤ãƒ³ã‚¸ã‚¦ãƒ ", symbol: "In", number: 49 },
                { name: "ã‚¹ã‚º", symbol: "Sn", number: 50 },
                { name: "ã‚¢ãƒ³ãƒãƒ¢ãƒ³", symbol: "Sb", number: 51 },
                { name: "ãƒ†ãƒ«ãƒ«", symbol: "Te", number: 52 },
                { name: "ãƒ¨ã‚¦ç´ ", symbol: "I", number: 53 },
                { name: "ã‚­ã‚»ãƒãƒ³", symbol: "Xe", number: 54 },
                { name: "ã‚»ã‚·ã‚¦ãƒ ", symbol: "Cs", number: 55 },
                { name: "ãƒãƒªã‚¦ãƒ ", symbol: "Ba", number: 56 }
            ]
        };

        // å…¨ã¦ã®å…ƒç´ ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ï¼ˆå…ƒç´ è¨˜å·è¡¨ç”¨ï¼‰
        const allElements = [
            ...elements.easy,
            ...elements.medium,
            ...elements.hard
        ];

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            currentScreen: 'menuScreen', // IDã‚’ä½¿ç”¨
            mode: 'normal', // 'normal' or 'weakness'
            difficulty: 'easy',
            currentQuestion: 0,
            score: 0,
            correctAnswers: 0,
            totalQuestions: 10,
            timeLeft: 30,
            timer: null,
            // â˜…ä¿®æ­£ç‚¹ï¼šæ¬¡ã®å•é¡Œã¸é·ç§»ã™ã‚‹ãŸã‚ã®ã‚¿ã‚¤ãƒãƒ¼IDã‚’ç®¡ç†
            nextQuestionTimeout: null, 
            combo: 0,
            maxCombo: 0,
            questionStartTime: 0,
            totalTime: 0,
            questions: [],
            settings: {
                sound: true,
                timer: true,
                combo: true
            }
        };

        // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
        let stats = JSON.parse(localStorage.getItem('elementStats')) || {
            totalGames: 0,
            totalCorrect: 0,
            totalQuestions: 0,
            bestScore: 0,
            averageScore: 0,
            difficultyStats: {
                easy: { played: 0, correct: 0, total: 0 },
                medium: { played: 0, correct: 0, total: 0 },
                hard: { played: 0, correct: 0, total: 0 }
            },
            elementLearningHistory: {}
        };

        // elementLearningHistoryã‚’åˆæœŸåŒ– (åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã‚„ãƒ‡ãƒ¼ã‚¿æ§‹é€ å¤‰æ›´æ™‚ã«å¿…è¦)
        function initializeElementLearningHistory() {
            let needsUpdate = false;
            if (!stats.elementLearningHistory) {
                stats.elementLearningHistory = {};
                needsUpdate = true;
            }
            allElements.forEach(el => {
                if (!stats.elementLearningHistory[el.symbol]) {
                    stats.elementLearningHistory[el.symbol] = { correct: 0, incorrect: 0 };
                    needsUpdate = true;
                }
            });
            if (needsUpdate) {
                localStorage.setItem('elementStats', JSON.stringify(stats));
            }
        }
        initializeElementLearningHistory();


        // ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰
        let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function showScreen(screenId) {
            // ã™ã¹ã¦ã®ç”»é¢è¦ç´ ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            document.querySelectorAll('.screen-container').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // æŒ‡å®šã•ã‚ŒãŸIDã®ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            // gameState.currentScreen ã‚’æ›´æ–°
            gameState.currentScreen = screenId;
        }

        function showMenu() {
            showScreen('menuScreen');
            // â˜…ä¿®æ­£ç‚¹ï¼šå…¨ã¦ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            if (gameState.nextQuestionTimeout) {
                clearTimeout(gameState.nextQuestionTimeout);
            }
        }

        function showModeSelector() {
            showScreen('modeSelector');
            document.querySelectorAll('#modeSelector .mode-button').forEach(btn => btn.classList.remove('active'));
            // gameState.mode ã«åŸºã¥ã„ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒœã‚¿ãƒ³ã‚’è¨­å®š
            const currentModeButton = document.querySelector(`#modeSelector .mode-button[onclick*="selectMode('${gameState.mode}')"]`);
            if (currentModeButton) {
                currentModeButton.classList.add('active');
            }
        }

        function showDifficultySelector() {
            showScreen('difficultySelector');
            document.querySelectorAll('#difficultySelector .difficulty-btn').forEach(btn => btn.classList.remove('active'));
            // gameState.difficulty ã«åŸºã¥ã„ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒœã‚¿ãƒ³ã‚’è¨­å®š
            const currentDifficultyButton = document.querySelector(`#difficultySelector .difficulty-btn[onclick*="selectDifficulty('${gameState.difficulty}')"]`);
            if (currentDifficultyButton) {
                currentDifficultyButton.classList.add('active');
            }
        }

        function showStats() {
            showScreen('statsScreen');
            updateStatsDisplay();
        }

        function showSettings() {
            showScreen('settingsScreen');
        }

        function showLeaderboard() {
            showScreen('leaderboardScreen');
            updateLeaderboard();
        }
        
        // å…ƒç´ è¨˜å·è¡¨ã®è¡¨ç¤º
        function showPeriodicTable() {
            showScreen('periodicTableScreen');
            generatePeriodicTableList();
        }

        // é›£æ˜“åº¦é¸æŠ
        function selectDifficulty(difficulty, event) {
            gameState.difficulty = difficulty;
            document.querySelectorAll('#difficultySelector .difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
        function selectMode(mode, event) {
            gameState.mode = mode;
            document.querySelectorAll('#modeSelector .mode-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // ã‚¯ã‚¤ã‚ºé–‹å§‹
        function startQuiz() {
            gameState.currentQuestion = 0;
            gameState.score = 0;
            gameState.correctAnswers = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.totalTime = 0;
            gameState.questions = generateQuestions();
            
            showScreen('quizScreen');
            showQuestion();
        }

        // å•é¡Œç”Ÿæˆ
        function generateQuestions() {
            const elementList = elements[gameState.difficulty];
            const questions = [];
            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿ä½¿ç”¨: ç¾åœ¨ã®ã‚¯ã‚¤ã‚ºã§å‡ºé¡Œã•ã‚ŒãŸå…ƒç´ ã®è¨˜å·ã‚’è¨˜éŒ²
            const selectedQuestionSymbolsForNormalMode = new Set(); 

            while (questions.length < gameState.totalQuestions) {
                let correctElement = null;

                if (gameState.mode === 'weakness') {
                    // è‹¦æ‰‹å…‹æœãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ä¸æ­£è§£å›æ•°ãŒå¤šã„å…ƒç´ ã‚’å„ªå…ˆ
                    const weightedElements = [];
                    elementList.forEach(el => {
                        const history = stats.elementLearningHistory[el.symbol];
                        let weight = 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é‡ã¿

                        if (history) {
                            const totalAttempts = history.correct + history.incorrect;
                            if (totalAttempts > 0) {
                                // ä¸æ­£è§£ç‡ãŒé«˜ã„ã»ã©é‡ã¿ãŒå¢—ã™
                                const incorrectRatio = history.incorrect / totalAttempts;
                                // æœ€ä½1ã€æœ€å¤§6ã®é‡ã¿ï¼ˆä¸æ­£è§£ç‡0%ã§1ã€100%ã§6ï¼‰
                                weight = 1 + Math.floor(incorrectRatio * 5); 
                            }
                        }
                        // é‡ã¿ã«å¿œã˜ã¦è¦ç´ ã‚’é…åˆ—ã«è¿½åŠ 
                        for (let i = 0; i < weight; i++) {
                            weightedElements.push(el);
                        }
                    });

                    // é‡ã¿ä»˜ã‘ã•ã‚ŒãŸãƒªã‚¹ãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
                    correctElement = weightedElements[Math.floor(Math.random() * weightedElements.length)];

                } else {
                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€é‡è¤‡ã—ãªã„ã‚ˆã†ã«ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
                    let availableElements = elementList.filter(el => !selectedQuestionSymbolsForNormalMode.has(el.symbol));
                    if (availableElements.length === 0) { 
                        availableElements = elementList.slice(); 
                        selectedQuestionSymbolsForNormalMode.clear();
                    }
                    correctElement = availableElements[Math.floor(Math.random() * availableElements.length)];
                    selectedQuestionSymbolsForNormalMode.add(correctElement.symbol);
                }
                
                // é–“é•ã„é¸æŠè‚¢ã‚’3ã¤è¿½åŠ  (é‡è¤‡ã—ãªã„ã‚ˆã†ã«)
                const wrongOptionsPool = allElements.filter(el => el !== correctElement); 
                const options = [correctElement];
                
                while (options.length < 4) {
                    const randomIndex = Math.floor(Math.random() * wrongOptionsPool.length);
                    const wrongElement = wrongOptionsPool[randomIndex];
                    if (!options.some(opt => opt.symbol === wrongElement.symbol)) { // optionsã«æ—¢ã«ãªã‘ã‚Œã°è¿½åŠ 
                        options.push(wrongElement);
                    }
                }
                
                // é¸æŠè‚¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                options.sort(() => Math.random() - 0.5);
                
                questions.push({
                    element: correctElement,
                    options: options,
                    questionType: Math.random() > 0.5 ? 'symbolToName' : 'nameToSymbol'
                });
            }
            
            return questions;
        }

        // å•é¡Œè¡¨ç¤º
        function showQuestion() {
            // ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
            document.querySelectorAll('#optionsContainer .quiz-button').forEach(btn => {
                btn.disabled = false;
            });

            const question = gameState.questions[gameState.currentQuestion];
            
            document.getElementById('questionNumber').textContent = gameState.currentQuestion + 1;
            document.getElementById('totalQuestions').textContent = gameState.totalQuestions;
            document.getElementById('currentScore').textContent = gameState.score;
            
            const progress = ((gameState.currentQuestion + 1) / gameState.totalQuestions) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            if (question.questionType === 'symbolToName') {
                document.getElementById('questionText').textContent = 'ã“ã®å…ƒç´ è¨˜å·ã¯ä½•ï¼Ÿ';
                document.getElementById('elementDisplay').textContent = question.element.symbol;
            } else {
                document.getElementById('questionText').textContent = 'ã“ã®å…ƒç´ ã®è¨˜å·ã¯ï¼Ÿ';
                document.getElementById('elementDisplay').textContent = question.element.name;
            }
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'quiz-button';
                button.textContent = question.questionType === 'symbolToName' ? option.name : option.symbol;
                button.onclick = () => selectAnswer(option, button);
                optionsContainer.appendChild(button);
            });
            
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            
            gameState.questionStartTime = Date.now();
            if (gameState.settings.timer) {
                startTimer();
                document.querySelector('.timer').style.display = 'inline';
            } else {
                document.querySelector('.timer').style.display = 'none';
            }
            
            updateComboDisplay();
        }

        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startTimer() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            gameState.timeLeft = 30;
            document.getElementById('timeLeft').textContent = gameState.timeLeft;
            
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timeLeft').textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    selectAnswer(null, null); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                }
            }, 1000);
        }

        // å›ç­”é¸æŠ
        function selectAnswer(selectedOption, buttonElement) {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            const question = gameState.questions[gameState.currentQuestion];
            const isCorrect = selectedOption && selectedOption.symbol === question.element.symbol;
            const responseTime = Date.now() - gameState.questionStartTime;
            
            document.querySelectorAll('#optionsContainer .quiz-button').forEach(btn => {
                btn.disabled = true;
            });

            if (stats.elementLearningHistory[question.element.symbol]) {
                if (isCorrect) {
                    stats.elementLearningHistory[question.element.symbol].correct++;
                } else {
                    stats.elementLearningHistory[question.element.symbol].incorrect++;
                }
                localStorage.setItem('elementStats', JSON.stringify(stats));
            }
            
            if (isCorrect) {
                gameState.correctAnswers++;
                gameState.combo++;
                gameState.maxCombo = Math.max(gameState.maxCombo, gameState.combo);
                gameState.totalTime += responseTime;
                
                const timeBonus = Math.max(0, Math.floor((30 - (responseTime / 1000)) * 5));
                const comboBonus = gameState.combo * 10;
                const points = 100 + timeBonus + comboBonus;
                gameState.score += points;
                
                if (buttonElement) {
                    buttonElement.classList.add('correct');
                    buttonElement.classList.add('animation-correct');
                }

                document.getElementById('feedback').textContent = `æ­£è§£ï¼ +${points}ç‚¹ï¼`;
                document.getElementById('feedback').classList.remove('incorrect');
                document.getElementById('feedback').classList.add('correct');

            } else {
                gameState.combo = 0;
                
                if (buttonElement) {
                    buttonElement.classList.add('incorrect');
                    buttonElement.classList.add('animation-incorrect');
                }
                
                document.querySelectorAll('.quiz-button').forEach(btn => {
                    const buttonText = btn.textContent;
                    const correctText = question.questionType === 'symbolToName' ? question.element.name : question.element.symbol;
                    if (buttonText === correctText) {
                        btn.classList.add('correct');
                    }
                });

                document.getElementById('feedback').textContent = `æ®‹å¿µï¼ æ­£è§£ã¯ ${question.questionType === 'symbolToName' ? question.element.name : question.element.symbol} ã§ã—ãŸã€‚`;
                document.getElementById('feedback').classList.remove('correct');
                document.getElementById('feedback').classList.add('incorrect');
            }

            updateComboDisplay();

            // â˜…ä¿®æ­£ç‚¹ï¼šæ¬¡ã®å•é¡Œã¸é·ç§»ã™ã‚‹å‡¦ç†ã‚’gameStateã«ä¿å­˜
            gameState.nextQuestionTimeout = setTimeout(() => {
                gameState.currentQuestion++;
                if (gameState.currentQuestion < gameState.totalQuestions) {
                    showQuestion();
                } else {
                    endQuiz();
                }
            }, 1500);
        }

        // ã‚³ãƒ³ãƒœè¡¨ç¤ºæ›´æ–°
        function updateComboDisplay() {
            const comboDisplay = document.getElementById('comboDisplay');
            if (gameState.settings.combo && gameState.combo > 1) { // 2ã‚³ãƒ³ãƒœä»¥ä¸Šã§è¡¨ç¤º
                comboDisplay.style.display = 'block';
                document.getElementById('comboNumber').textContent = gameState.combo;
            } else {
                comboDisplay.style.display = 'none';
            }
        }

        // ã‚¯ã‚¤ã‚ºçµ‚äº†
        function endQuiz() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }

            const accuracy = gameState.totalQuestions > 0 ? (gameState.correctAnswers / gameState.totalQuestions) * 100 : 0;
            const avgTime = gameState.correctAnswers > 0 ? (gameState.totalTime / gameState.correctAnswers / 1000).toFixed(2) : 0;

            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('correctCount').textContent = gameState.correctAnswers;
            document.getElementById('accuracyRate').textContent = `${accuracy.toFixed(1)}%`;
            document.getElementById('maxCombo').textContent = gameState.maxCombo;
            document.getElementById('avgTime').textContent = `${avgTime}s`;

            let resultText = '';
            if (accuracy === 100) {
                resultText = 'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ç´ æ™´ã‚‰ã—ã„ï¼';
            } else if (accuracy >= 80) {
                resultText = 'ã‚ˆãã§ãã¾ã—ãŸï¼ã‚‚ã£ã¨ä¸Šã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼';
            } else if (accuracy >= 50) {
                resultText = 'ã‚ã¨ä¸€æ¯ï¼é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼';
            } else {
                resultText = 'ãƒ‰ãƒ³ãƒã‚¤ï¼ç¹°ã‚Šè¿”ã—ç·´ç¿’ã—ã¾ã—ã‚‡ã†ï¼';
            }
            document.getElementById('resultText').textContent = resultText;

            // çµ±è¨ˆã‚’æ›´æ–°
            stats.totalGames++;
            stats.totalCorrect += gameState.correctAnswers;
            stats.totalQuestions += gameState.totalQuestions;
            if (gameState.score > stats.bestScore) {
                stats.bestScore = gameState.score;
            }
            stats.averageScore = stats.totalGames > 1 ? ((stats.averageScore * (stats.totalGames - 1)) + gameState.score) / stats.totalGames : gameState.score;

            stats.difficultyStats[gameState.difficulty].played++;
            stats.difficultyStats[gameState.difficulty].correct += gameState.correctAnswers;
            stats.difficultyStats[gameState.difficulty].total += gameState.totalQuestions;

            localStorage.setItem('elementStats', JSON.stringify(stats));

            // ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
            leaderboard.push({
                score: gameState.score,
                difficulty: gameState.difficulty,
                mode: gameState.mode,
                date: new Date().toLocaleString('ja-JP')
            });
            leaderboard.sort((a, b) => b.score - a.score);
            if (leaderboard.length > 10) {
                leaderboard = leaderboard.slice(0, 10);
            }
            localStorage.setItem('leaderboard', JSON.stringify(leaderboard));

            showScreen('resultScreen');
        }

        // çµ±è¨ˆè¡¨ç¤ºã‚’æ›´æ–°
        function updateStatsDisplay() {
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalGames}</div>
                    <div class="stat-label">ç·ãƒ—ãƒ¬ã‚¤å›æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.totalCorrect}</div>
                    <div class="stat-label">ç·æ­£è§£æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.totalQuestions}</div>
                    <div class="stat-label">ç·å•é¡Œæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${(stats.totalQuestions > 0 ? (stats.totalCorrect / stats.totalQuestions) * 100 : 0).toFixed(1)}%</div>
                    <div class="stat-label">å…¨ä½“æ­£ç­”ç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.bestScore}</div>
                    <div class="stat-label">æœ€é«˜ã‚¹ã‚³ã‚¢</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.averageScore.toFixed(0)}</div>
                    <div class="stat-label">å¹³å‡ã‚¹ã‚³ã‚¢</div>
                </div>
            `;

            const difficultyNames = { easy: 'åˆç´š', medium: 'ä¸­ç´š', hard: 'ä¸Šç´š' };
            for (const diff in stats.difficultyStats) {
                const diffStats = stats.difficultyStats[diff];
                const diffAccuracy = diffStats.total > 0 ? (diffStats.correct / diffStats.total) * 100 : 0;
                statsContainer.innerHTML += `
                    <div class="stat-card">
                        <div class="stat-number">${diffStats.played}</div>
                        <div class="stat-label">${difficultyNames[diff]}ãƒ—ãƒ¬ã‚¤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${diffStats.correct} / ${diffStats.total}</div>
                        <div class="stat-label">${difficultyNames[diff]}æ­£è§£æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${diffAccuracy.toFixed(1)}%</div>
                        <div class="stat-label">${difficultyNames[diff]}æ­£ç­”ç‡</div>
                    </div>
                `;
            }

            const weaknessStatsDiv = document.createElement('div');
            weaknessStatsDiv.style.gridColumn = '1 / -1';
            weaknessStatsDiv.innerHTML = '<h4 style="text-align: center; margin-top: 30px; margin-bottom: 10px; color: #333;">è‹¦æ‰‹å…ƒç´ ï¼ˆä¸æ­£è§£ç‡é †ï¼‰</h4>';
            
            const sortedElements = Object.entries(stats.elementLearningHistory)
                .map(([symbol, data]) => {
                    const elementInfo = allElements.find(el => el.symbol === symbol);
                    const name = elementInfo ? elementInfo.name : symbol;
                    const total = data.correct + data.incorrect;
                    return {
                        symbol,
                        name,
                        correct: data.correct,
                        incorrect: data.incorrect,
                        total: total,
                        incorrectRatio: total > 0 ? data.incorrect / total : 0
                    };
                })
                .filter(el => el.total > 0)
                .sort((a, b) => b.incorrectRatio - a.incorrectRatio || b.incorrect - a.incorrect);

            if (sortedElements.length > 0) {
                const weaknessList = document.createElement('ul');
                weaknessList.style.listStyle = 'none';
                weaknessList.style.padding = '0';
                weaknessList.style.margin = '0 auto';
                weaknessList.style.maxWidth = '400px';

                sortedElements.slice(0, 10).forEach(el => { // ä¸Šä½10ä»¶ã®ã¿è¡¨ç¤º
                    const listItem = document.createElement('li');
                    listItem.style.padding = '8px 15px';
                    listItem.style.marginBottom = '5px';
                    listItem.style.background = '#f0f4ff';
                    listItem.style.borderRadius = '8px';
                    listItem.style.display = 'flex';
                    listItem.style.justifyContent = 'space-between';
                    listItem.style.alignItems = 'center';

                    listItem.innerHTML = `
                        <span style="font-weight: bold; color: #667eea;">${el.name} (${el.symbol})</span>
                        <span>ä¸æ­£è§£: <span style="color: #f44336; font-weight: bold;">${el.incorrect}</span> / æ­£è§£: ${el.correct}</span>
                        <span style="font-weight: bold;">${(el.incorrectRatio * 100).toFixed(1)}%</span>
                    `;
                    weaknessList.appendChild(listItem);
                });
                weaknessStatsDiv.appendChild(weaknessList);
                statsContainer.appendChild(weaknessStatsDiv);
            } else {
                weaknessStatsDiv.innerHTML += '<p style="text-align: center; color: #666;">ã¾ã å­¦ç¿’å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                statsContainer.appendChild(weaknessStatsDiv);
            }
        }

        // ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
        function updateLeaderboard() {
            const leaderboardContainer = document.getElementById('leaderboardContainer');
            leaderboardContainer.innerHTML = '';

            if (leaderboard.length === 0) {
                leaderboardContainer.innerHTML = '<p style="text-align: center; color: #666;">ã¾ã ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            leaderboard.forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                const difficultyName = { easy: 'åˆç´š', medium: 'ä¸­ç´š', hard: 'ä¸Šç´š' }[entry.difficulty];
                const modeName = { normal: 'é€šå¸¸', weakness: 'è‹¦æ‰‹' }[entry.mode];
                item.innerHTML = `
                    <span class="rank">#${index + 1}</span>
                    <span>ã‚¹ã‚³ã‚¢: ${entry.score}</span>
                    <span>é›£æ˜“åº¦: ${difficultyName}</span>
                    <span>ãƒ¢ãƒ¼ãƒ‰: ${modeName}</span>
                    <span style="font-size: 0.8em; color: #666;">${entry.date}</span>
                `;
                leaderboardContainer.appendChild(item);
            });
        }

        // å…ƒç´ è¨˜å·ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¦è¡¨ç¤º
        function generatePeriodicTableList() {
            const container = document.getElementById('elementListContainer');
            container.innerHTML = '';

            allElements.sort((a, b) => a.number - b.number);

            allElements.forEach(element => {
                const item = document.createElement('div');
                item.className = 'element-item';
                item.innerHTML = `
                    <div class="symbol">${element.symbol}</div>
                    <div class="name">${element.name}</div>
                    <div class="number">No.${element.number}</div>
                `;
                container.appendChild(item);
            });
        }

        // è¨­å®šã®åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        function initializeSettings() {
            const savedSettings = JSON.parse(localStorage.getItem('elementSettings'));
            if (savedSettings) {
                gameState.settings = { ...gameState.settings, ...savedSettings };
            }

            document.getElementById('soundToggle').checked = gameState.settings.sound;
            document.getElementById('timerToggle').checked = gameState.settings.timer;
            document.getElementById('comboToggle').checked = gameState.settings.combo;

            document.getElementById('soundToggle').addEventListener('change', (e) => {
                gameState.settings.sound = e.target.checked;
                localStorage.setItem('elementSettings', JSON.stringify(gameState.settings));
            });
            document.getElementById('timerToggle').addEventListener('change', (e) => {
                gameState.settings.timer = e.target.checked;
                localStorage.setItem('elementSettings', JSON.stringify(gameState.settings));
                document.querySelector('.timer').style.display = gameState.settings.timer ? 'inline' : 'none';
            });
            document.getElementById('comboToggle').addEventListener('change', (e) => {
                gameState.settings.combo = e.target.checked;
                localStorage.setItem('elementSettings', JSON.stringify(gameState.settings));
                updateComboDisplay();
            });
            
            document.querySelector('.timer').style.display = gameState.settings.timer ? 'inline' : 'none';
        }

        // â˜…ä¿®æ­£ç‚¹ï¼šèµ·å‹•æ™‚ã®å‡¦ç†ã‚’ä¿®æ­£
        window.onload = () => {
            initializeSettings();
            // æœ€åˆã«å¿…ãšãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
            showMenu();
            // å„ç”»é¢ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠçŠ¶æ…‹ã‚’åˆæœŸåŒ–ã—ã¦ãŠã
            const initialModeButton = document.querySelector(`#modeSelector .mode-button[onclick*="selectMode('${gameState.mode}')"]`);
            if (initialModeButton) initialModeButton.classList.add('active');
            
            const initialDifficultyButton = document.querySelector(`#difficultySelector .difficulty-btn[onclick*="selectDifficulty('${gameState.difficulty}')"]`);
            if (initialDifficultyButton) initialDifficultyButton.classList.add('active');
        };
    </script>
</body>
</html>
