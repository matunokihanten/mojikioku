<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>数字探し脳トレゲーム 重なりなし配置版</title>
<style>
* { box-sizing: border-box; }
html,body {
    height: 100%; margin: 0; overflow: hidden;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex; justify-content: center; align-items: center;
    padding: 1vh 1vw; user-select: none;
}
#game-container {
    width: 100%; height: 100%; max-width: 800px; max-height: 900px;
    display: flex; flex-direction: column;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px); overflow: hidden;
    animation: containerFadeIn 0.8s ease-out;
}
@keyframes containerFadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}
.header {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white; padding: clamp(15px, 3vh, 25px);
    display: flex; flex-wrap: wrap;
    align-items: center; justify-content: space-between; gap: 10px;
}
.logo { font-size: clamp(1.2em, 4vw, 1.8em); font-weight: bold; }
.stats { display: flex; gap: 15px; align-items: center; font-size: clamp(0.9em, 3vw, 1.1em);}
.stat-item { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 15px; display: flex; gap: 5px; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
.mode-toggle { background: rgba(255,255,255,0.2); border-radius: 25px; padding: 5px; display: flex; gap: 5px; }
.mode-toggle input[type="radio"] { display: none; }
.mode-toggle label { padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-size: clamp(0.8em, 2.5vw, 1em);}
.mode-toggle input[type="radio"]:checked + label { background: rgba(255,255,255,0.9); color: #4CAF50; font-weight: bold; transform: scale(1.05);}
select, button { padding: 8px 16px; border: none; border-radius: 20px; background: rgba(255,255,255,0.9); cursor: pointer; transition: 0.3s;}
button:hover, select:hover { background: #fff; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2);}
.game-area { flex: 1; padding: clamp(20px, 4vh, 30px); display: flex; flex-direction: column; gap: 20px; }
.question-bar { background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: #fff; padding: 15px; border-radius: 15px; text-align: center; font-size: clamp(1.5em, 5vw, 2.5em); font-weight: bold; }
#game-board { flex: 1; position: relative; border-radius: 15px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); overflow: hidden; }
.number-cell {
    position: absolute; font-weight: bold; cursor: pointer; border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    transition: all 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    width: 40px; height: 40px; font-size: 18px; user-select:none;
}
.number-cell.found { animation: numberFound 0.6s ease-out forwards; pointer-events:none; }
@keyframes numberFound { 0% {transform: scale(1.2);} 100% {transform: scale(0.6); opacity:0.2;} }
.number-cell.target-hint { animation: targetPulse 1s infinite alternate; }
@keyframes targetPulse { from { box-shadow: 0 0 0 rgba(0,0,0,0.2);} to { box-shadow: 0 0 20px gold; transform: scale(1.1);} }
.progress-bar { height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden;}
.progress-fill { height:100%; background: linear-gradient(90deg,#4CAF50,#45a049); transition: width 0.5s;}
.hint-button { position: absolute; bottom: 20px; right: 20px; border-radius: 50%; width: 50px; height: 50px; background:#FF6B6B; color:#fff; border:none; font-size:1.2em; }
#game-over-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center;}
.game-over-content { background: white; padding: 40px; border-radius: 20px; max-width: 400px; text-align:center;}
.game-over-content h2 { color:#4CAF50; }
.achievement { display:inline-block; background: linear-gradient(135deg, #FFD700, #FFA500); padding:5px 15px; border-radius:20px; margin:5px;}
.combo-display { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:3em; color:#FF6B6B; animation: comboAnimation 1s ease-out; }
@keyframes comboAnimation { 0%{opacity:0;transform:scale(0.5);}50%{opacity:1;transform:scale(1.2);}100%{opacity:0;transform:scale(1);} }
@keyframes shake {0%,100%{transform:translateX(0);}25%{transform:translateX(-5px);}75%{transform:translateX(5px);} }
</style>
</head>
<body>
<div id="game-container">
    <div class="header">
        <div class="logo">🧠 数字探し</div>
        <div class="stats">
            <div class="stat-item"><span>⏱️</span><span id="timer">00:00</span></div>
            <div class="stat-item"><span>🎯</span><span id="score">0</span></div>
            <div class="stat-item"><span>🔥</span><span id="combo">0</span></div>
        </div>
        <div class="controls">
            <div class="mode-toggle">
                <input type="radio" id="timeMode" name="mode">
                <label for="timeMode">タイム</label>
                <input type="radio" id="relaxMode" name="mode" checked>
                <label for="relaxMode">リラックス</label>
            </div>
            <select id="difficulty">
                <option value="15">初心者(15)</option>
                <option value="25">初級(25)</option>
                <option value="50">中級(50)</option>
                <option value="100" selected>上級(100)</option>
                <option value="150">エキスパート(150)</option>
            </select>
            <button id="reset">🔄リセット</button>
            <button id="sound">🔊</button>
        </div>
    </div>
    <div class="game-area">
        <div id="question" class="question-bar">ゲームを開始してください</div>
        <div class="progress-bar"><div id="progress" class="progress-fill" style="width:0"></div></div>
        <div id="game-board"></div>
        <button id="hint" class="hint-button">💡</button>
    </div>
</div>
<div id="game-over-overlay">
    <div class="game-over-content">
        <h2 id="over-title">🎉 ゲームクリア！</h2>
        <div id="over-stats"></div>
        <div id="achievements"></div>
        <button id="play-again">もう一度</button>
    </div>
</div>

<script>
class NumberHunt {
    constructor(){
        this.board=document.getElementById("game-board");
        this.q=document.getElementById("question");
        this.timerEl=document.getElementById("timer");
        this.scoreEl=document.getElementById("score");
        this.comboEl=document.getElementById("combo");
        this.progress=document.getElementById("progress");
        this.resetBtn=document.getElementById("reset");
        this.difficultySel=document.getElementById("difficulty");
        this.soundBtn=document.getElementById("sound");
        this.time=document.getElementById("timeMode");
        this.relax=document.getElementById("relaxMode");
        this.hintBtn=document.getElementById("hint");
        this.over=document.getElementById("game-over-overlay");
        this.overTitle=document.getElementById("over-title");
        this.overStats=document.getElementById("over-stats");
        this.achv=document.getElementById("achievements");
        this.playAgain=document.getElementById("play-again");

        this.CELL_SIZE=40;
        this.NUM_MIN=1;
        this.NUM_MAX=100;

        this.COLORS=["#e74c3c","#f39c12","#1abc9c","#2980b9","#8e44ad","#2c3e50","#d35400","#c0392b","#16a085","#34495e","#9b59b6","#3498db","#f1c40f","#e67e22","#7f8c8d"];

        this.score=0; this.combo=0; this.maxCombo=0;
        this.found=0; this.wrong=0; this.hints=0; this.start=0; this.interval=null;
        this.current=null; this.toFind=[]; this.toAdd=[];
        this.sound=true; this.isTime=false; this.diff=100;

        this.resetBtn.onclick=()=>this.setup();
        this.difficultySel.onchange=()=>{this.diff=+this.difficultySel.value;this.setup();};
        this.time.onchange=()=>{this.isTime=true;this.setup();};
        this.relax.onchange=()=>{this.isTime=false;this.setup();};

        this.soundBtn.onclick=()=>{
            this.sound=!this.sound;
            this.soundBtn.textContent=this.sound?"🔊":"🔇";
        };
        this.hintBtn.onclick=()=>this.showHint();
        this.playAgain.onclick=()=>{
            this.over.style.display="none";
            this.setup();
        };

        this.setup();
        window.addEventListener('resize', ()=>this.repositionNumbers());
    }
    setup(){
        clearInterval(this.interval);
        this.board.innerHTML="";
        this.score=0;this.combo=0;this.maxCombo=0;this.found=0;this.wrong=0;this.hints=0;
        this.start=0;this.current=null;this.q.textContent="開始！";

        // 1～100の数字配列生成してシャッフル
        let all=[];
        for(let i=this.NUM_MIN;i<=this.NUM_MAX;i++) all.push(i);
        this.shuffle(all);

        // 画面難易度以内で表示数字決定
        let display=all.slice(0,this.diff);
        this.toFind=[...display];
        this.toAdd=all.filter(n=>!display.includes(n));

        // 探す順はシャッフル
        this.shuffle(this.toFind);

        // 配置
        this.placeNumbersNoOverlap(display);

        this.ask();
        this.updateUI();
    }

    placeNumbersNoOverlap(nums){
        const rect=this.board.getBoundingClientRect();
        const positions=[]; // 置いた数字の中心座標保持

        // 1回の配置試行の最大リトライ回数
        const MAX_TRIES=200;

        nums.forEach(num=>{
            let placed=false, tries=0;
            while(!placed&&tries<MAX_TRIES){
                // ランダム位置（左上基準）
                let x = Math.random()*(rect.width-this.CELL_SIZE);
                let y = Math.random()*(rect.height-this.CELL_SIZE);

                // 中心座標計算
                let cx = x + this.CELL_SIZE/2;
                let cy = y + this.CELL_SIZE/2;

                // 既存の数字と重なり判定（中心間距離 >= CELL_SIZE を確保）
                let collision=positions.some(pos=>{
                    let dx=pos.x - cx;
                    let dy=pos.y - cy;
                    return Math.sqrt(dx*dx+dy*dy) < this.CELL_SIZE;
                });

                if(!collision){
                    positions.push({x:cx,y:cy});
                    const div=document.createElement("div");
                    div.className="number-cell";
                    div.textContent=num;
                    div.dataset.n=num;
                    let color=this.COLORS[Math.floor(Math.random()*this.COLORS.length)];
                    div.style.color=color;
                    div.style.background=`rgba(0,0,0,0.05)`;
                    div.style.left=`${x}px`;
                    div.style.top=`${y}px`;
                    div.style.width=this.CELL_SIZE+"px";
                    div.style.height=this.CELL_SIZE+"px";
                    div.style.fontSize="18px";
                    div.style.lineHeight=this.CELL_SIZE+"px";
                    div.style.textAlign="center";
                    div.onclick=e=>this.handleClick(e);
                    this.board.appendChild(div);
                    placed=true;
                } else {
                    tries++;
                }
            }
            if(!placed){
                // 万一リトライ尽きたら重ならない保証なしで配置
                let x = Math.random()*(rect.width-this.CELL_SIZE);
                let y = Math.random()*(rect.height-this.CELL_SIZE);
                const div=document.createElement("div");
                div.className="number-cell";
                div.textContent=num;
                div.dataset.n=num;
                let color=this.COLORS[Math.floor(Math.random()*this.COLORS.length)];
                div.style.color=color;
                div.style.background=`rgba(0,0,0,0.05)`;
                div.style.left=`${x}px`;
                div.style.top=`${y}px`;
                div.style.width=this.CELL_SIZE+"px";
                div.style.height=this.CELL_SIZE+"px";
                div.style.fontSize="18px";
                div.style.lineHeight=this.CELL_SIZE+"px";
                div.style.textAlign="center";
                div.onclick=e=>this.handleClick(e);
                this.board.appendChild(div);
                positions.push({x:x+this.CELL_SIZE/2,y:y+this.CELL_SIZE/2});
            }
        });
    }

    repositionNumbers(){
        // ウィンドウリサイズ時に既に配置された数字を再配置（少し重なる可能性あり）
        if(!this.board) return;
        const rect=this.board.getBoundingClientRect();
        const cells=[...this.board.getElementsByClassName('number-cell')];
        const positions=[];
        const MAX_TRIES=100;
        cells.forEach(cell=>{
            let placed=false, tries=0;
            while(!placed&&tries<MAX_TRIES){
                let x = Math.random()*(rect.width-this.CELL_SIZE);
                let y = Math.random()*(rect.height-this.CELL_SIZE);
                let cx = x + this.CELL_SIZE/2;
                let cy = y + this.CELL_SIZE/2;
                let collision=positions.some(pos=>{
                    let dx=pos.x-cx;
                    let dy=pos.y-cy;
                    return Math.sqrt(dx*dx+dy*dy)<this.CELL_SIZE;
                });
                if(!collision){
                    positions.push({x:cx,y:cy});
                    cell.style.left=`${x}px`;
                    cell.style.top=`${y}px`;
                    placed=true;
                } else {
                    tries++;
                }
            }
            if(!placed){
                let x = Math.random()*(rect.width-this.CELL_SIZE);
                let y = Math.random()*(rect.height-this.CELL_SIZE);
                cell.style.left=`${x}px`;
                cell.style.top=`${y}px`;
                positions.push({x:x+this.CELL_SIZE/2,y:y+this.CELL_SIZE/2});
            }
        });
    }

    ask(){
        if(!this.toFind.length){
            this.finish();
            return;
        }
        this.current=this.toFind[0];
        this.q.textContent=`🎯 ${this.current}を探せ！`;
        if(!this.start&&this.isTime){
            this.start=Date.now();
            this.interval=setInterval(()=>this.updateTimer(),200);
        }
    }
    updateTimer(){
        let t=Date.now()-this.start;
        let m=Math.floor(t/60000);
        let s=Math.floor((t%60000)/1000);
        this.timerEl.textContent=`${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }
    handleClick(e){
        if(!this.current) return;
        let n=+e.target.dataset.n;
        if(n===this.current){
            e.target.classList.add("found");
            this.toFind.shift();
            this.combo++;
            this.maxCombo=Math.max(this.combo,this.maxCombo);
            this.score+=10+this.combo*5;
            this.found++;
            this.showCombo();
            if(!this.isTime && this.toAdd.length){
                // 新しい数字を一つ追加配置
                const next=this.toAdd.shift();
                this.toFind.push(next);
                this.placeNumbersNoOverlap([next]);
                this.shuffle(this.toFind);
            }
            this.ask();
        } else {
            this.combo=0;
            this.wrong++;
            e.target.style.animation="shake 0.5s";
            setTimeout(()=>e.target.style.animation="",500);
        }
        this.updateUI();
    }
    showHint(){
        if(!this.current) return;
        let cells=[...this.board.querySelectorAll(`[data-n="${this.current}"]`)];
        cells.forEach(c=>{
            if(!c.classList.contains("found")){
                c.classList.add("target-hint");
                setTimeout(()=>c.classList.remove("target-hint"),2000);
            }
        });
        this.hints++;
    }
    showCombo(){
        if(this.combo<=1) return;
        let cd=document.createElement("div");
        cd.className="combo-display";
        cd.textContent=`COMBO×${this.combo}`;
        this.board.appendChild(cd);
        setTimeout(()=>cd.remove(),1000);
    }
    updateUI(){
        this.scoreEl.textContent=this.score;
        this.comboEl.textContent=this.combo;
        this.progress.style.width=`${(this.found/this.diff)*100}%`;
    }
    finish(){
        clearInterval(this.interval);
        let acc=Math.round(this.found/(this.found+this.wrong)*100)||0;
        this.q.textContent="🎉クリア！";
        this.over.style.display="flex";
        this.overStats.innerHTML=`
            <div>スコア:${this.score}</div>
            <div>発見:${this.found}</div>
            ${this.isTime?`<div>タイム:${this.timerEl.textContent}</div>`:""}
            <div>最大コンボ:${this.maxCombo}</div>
            <div>精度:${acc}%</div>
            <div>ヒント:${this.hints}</div>
        `;
        let ach=[];
        if(this.maxCombo>=10) ach.push("🔥コンボマスター");
        if(acc===100) ach.push("🎯パーフェクト");
        if(this.hints===0) ach.push("🧠自力クリア");
        this.achv.innerHTML = ach.map(a=>`<div class="achievement">${a}</div>`).join('');
    }
    shuffle(arr){
        for(let i=arr.length-1; i>0; i--){
            let j=Math.floor(Math.random()*(i+1));
            [arr[i], arr[j]]=[arr[j], arr[i]];
        }
    }
}

window.onload=()=>new NumberHunt();
</script>

</body>
</html>
