<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Êï∞Â≠óÊé¢„ÅóËÑ≥„Éà„É¨„Ç≤„Éº„É† - Â§öÊï∞„Åã„Çâ1ÂÄãÊé¢„Åó</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body {
      font-family: 'Arial', sans-serif;
      display: flex; justify-content: center; align-items: center;
      background-color: #3498db; color: #fff; user-select: none;
      padding: 1vh 1vw; box-sizing: border-box;
    }
    #game-container {
      width: 100%; height: 100%; max-width: 700px; max-height: 900px;
      display: flex; flex-direction: column; text-align: center;
      background-color: #2c3e50;
      padding: clamp(10px, 2vh, 20px); border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2); box-sizing: border-box;
      position: relative;
    }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; margin-bottom: clamp(10px,2vh,20px); flex-shrink: 0;
    }
    #question {
      font-size: clamp(1.2em, 4vw, 2em); font-weight: bold;
      background-color: #fff; color: #2c3e50;
      padding: 1vh 2vw; border-radius: 10px; flex-grow: 1; margin: 5px;
      order: 2;
    }
    #timer {
      font-size: clamp(1em, 3.5vw, 1.5em); font-weight: bold; color: #f1c40f;
      min-width: 70px; text-align: right; order: 3; display: none;
    }
    .header button, #difficulty-select {
      font-size: clamp(0.9em,3vw,1.2em); padding: 1vh 1.5vw;
      border: none; background-color: #f1c40f; color: #2c3e50; border-radius: 8px;
      cursor: pointer; transition: transform 0.1s, background-color 0.2s;
      margin: 5px; white-space: nowrap;
    }
    #reset-button { order: 1; }
    #endless-stop-button { order: 4; display: none; }
    #difficulty-select { order: 1; padding-right: 30px; }
    #difficulty-select {
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%232c3e50" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
      background-repeat: no-repeat; background-position: right 8px center;
    }
    .header button:active { transform: scale(0.95); }
    #game-board {
      position: relative; width: 100%; flex-grow: 1;
      background-color: #ecf0f1; border-radius: 10px; overflow: hidden;
      min-height: 0;
    }
    .number-cell {
      position: absolute; font-weight: bold; cursor: pointer;
      display: flex; justify-content: center; align-items: center;
      transition: opacity 0.3s, transform 0.1s;
      line-height: 1; padding: 2px; box-sizing: border-box; white-space: nowrap;
      background: #fff9; box-shadow: 0 2px 6px #8884; border-radius: 6px;
      outline: solid 2px #ddd6; z-index: 3; user-select: none;
    }
    .number-cell.found {
      opacity: 0.2; pointer-events: none; filter: grayscale(1);
    }
    #game-over-message {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.7); color: #fff; display: none;
      flex-direction: column; justify-content: center; align-items: center;
      border-radius: 10px; font-size: clamp(1.8em,6vw,2.5em); font-weight: bold;
      z-index: 20;
    }
    #game-over-message p { margin: 10px 0; }
    #final-time { color: #f1c40f; font-size: 1.2em; }
    #chart-section {
      display: none; position: absolute; top: 0; left: 0;
      width: 100%; height:100%; background: rgba(10,10,40, 0.95);
      z-index:22; justify-content: center; align-items: center; flex-direction:column;
    }
    #chart-canvas { max-width: 90vw; max-height: 50vh; background: #fff; border-radius: 16px; }
    #close-chart {
      margin-top:16px; padding: 1em 2em; font-size: 1.2em; background:#f1c40f; color:#2c3e50;
      border: none; border-radius: 8px; cursor: pointer;
      transition:background 0.2s;
    }
    #close-chart:active { background: #fff24a; }
    @media (max-width: 450px) {
      .header { flex-direction: row; justify-content: space-around; }
      #question { width: 100%; margin: 5px 0; text-align: center; }
      #timer { min-width: auto; }
    }
    .mode-selection {
      display: flex; align-items: center; flex-wrap:nowrap;
      margin-right: 15px; white-space: nowrap; order: 0;
    }
    .mode-selection input[type="radio"] { margin-right: 5px; }
  </style>
</head>
<body>
  <div id="game-container">
    <div class="header">
      <div class="mode-selection">
        <input type="radio" id="timeMode" name="gameMode" value="time">
        <label for="timeMode">„Çø„Ç§„É†</label>
        <input type="radio" id="relaxMode" name="gameMode" value="relax" checked>
        <label for="relaxMode">„É™„É©„ÉÉ„ÇØ„Çπ</label>
      </div>
      <button id="reset-button" title="„É™„Çª„ÉÉ„Éà">üîÑ „É™„Çª„ÉÉ„Éà</button>
      <select id="difficulty-select">
        <option value="25">ÂàùÁ¥ö (25)</option>
        <option value="50">‰∏≠Á¥ö (50)</option>
        <option value="100" selected>‰∏äÁ¥ö (100)</option>
      </select>
      <button id="endless-stop-button">ÁµÇ‰∫Ü</button>
      <div id="question"></div>
      <div id="timer">00:00</div>
    </div>
    <div id="game-board"></div>
    <div id="game-over-message">
      <p>„Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ</p>
      <p id="final-time"></p>
    </div>
    <div id="chart-section">
      <canvas id="chart-canvas"></canvas>
      <button id="close-chart">Èñâ„Åò„Çã</button>
    </div>
  </div>

  <script>
    const COLORS = [
      '#e74c3c','#f39c12','#1abc9c','#2980b9','#8e44ad',
      '#2c3e50','#d35400','#c0392b','#16a085','#34495e',
      '#9b59b6','#3498db','#f1c40f','#e67e22','#7f8c8d'
    ];
    const MIN_NUMBER=1, MAX_NUMBER=100, MAX_ATTEMPTS=500;

    const gameBoard=document.getElementById('game-board');
    const questionEl=document.getElementById('question');
    const resetButton=document.getElementById('reset-button');
    const difficultySelect=document.getElementById('difficulty-select');
    const timerEl=document.getElementById('timer');
    const gameOverMessage=document.getElementById('game-over-message');
    const finalTimeEl=document.getElementById('final-time');
    const timeModeRadio=document.getElementById('timeMode');
    const relaxModeRadio=document.getElementById('relaxMode');
    const endlessStopButton=document.getElementById('endless-stop-button');
    const chartSection=document.getElementById('chart-section');
    const closeChartBtn=document.getElementById('close-chart');
    const chartCanvas=document.getElementById('chart-canvas');

    let allNumbers=[], numbersPanel=[], numbersLeft=[], currentTarget=null;
    let gameStarted=false, startTime=0, timerInterval=null;
    let currentDifficulty=100, isTimeMode=false;
    let tapTimes=[], lastTapTime=0, chartObj=null, handlingResize=false;
    let placedRects=[];

    function getRandomInt(min,max){
      return Math.floor(Math.random()* (max-min+1))+min;
    }
    function shuffleArray(a){
      for(let i=a.length-1;i>0;i--){
        let j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
    }
    function measureCellRect(cell){
      return {
        left:parseFloat(cell.style.left),
        top:parseFloat(cell.style.top),
        width:cell.offsetWidth,
        height:cell.offsetHeight,
        get right(){return this.left+this.width;},
        get bottom(){return this.top+this.height;}
      };
    }
    function createNumberCell(num){
      const c=document.createElement('div');
      c.classList.add('number-cell');
      c.textContent=num;
      c.dataset.number=num;
      const fontMin=Math.min(18,gameBoard.clientHeight/15);
      const fontMax=Math.max(24,gameBoard.clientHeight/8);
      const sz=getRandomInt(fontMin,fontMax);
      c.style.fontSize=sz+'px';
      c.style.color=COLORS[getRandomInt(0,COLORS.length-1)];
      c.style.transform=`rotate(${getRandomInt(-35,35)}deg)`;
      return c;
    }

    // „Çø„Ç§„É´Áä∂„Å´Èáç„Å™„Çâ„Åö„Å´ÂÖ®ÁîªÈù¢„Å´ÈÖçÁΩÆ
    function placeBoardNumbers(numbers){
      gameBoard.innerHTML='';
      placedRects=[];
      const count=numbers.length;
      const W=gameBoard.clientWidth, H=gameBoard.clientHeight;
      const aspect=W/H;
      const cols=Math.ceil(Math.sqrt(count*aspect));
      const rows=Math.ceil(count/cols);
      const cellW=W/cols, cellH=H/rows;
      numbers.forEach((num,i)=>{
        const cell=createNumberCell(num);
        // ÊñáÂ≠ó„Åå„ÅØ„ÅøÂá∫„Åï„Å™„ÅÑ„Çà„ÅÜ„Å´„Éï„Ç©„É≥„ÉàË™øÊï¥
        const fs=Math.min(cellH*0.6,cellW*0.6);
        cell.style.fontSize=fs+'px';
        gameBoard.appendChild(cell);
        const col=i%cols, row=Math.floor(i/cols);
        const left=col*cellW + (cellW-cell.offsetWidth)/2;
        const top=row*cellH + (cellH-cell.offsetHeight)/2;
        cell.style.left=left+'px';
        cell.style.top=top+'px';
        placedRects.push(measureCellRect(cell));
        cell.addEventListener('click',handleNumberClick);
        enableDrag(cell);
      });
    }

    function setupGame(){
      if(chartObj){chartObj.destroy();chartObj=null;}
      chartSection.style.display='none';
      gameOverMessage.style.display='none';
      clearInterval(timerInterval);
      timerEl.textContent='00:00';
      gameStarted=false;
      tapTimes=[];
      placedRects=[];
      endlessStopButton.style.display=isTimeMode?'none':'inline-block';
      timerEl.style.display=isTimeMode?'block':'none';
      allNumbers=[];
      for(let i=MIN_NUMBER;i<=MAX_NUMBER;i++) allNumbers.push(i);
      shuffleArray(allNumbers);
      numbersPanel=allNumbers.slice(0,currentDifficulty);
      numbersLeft=[...numbersPanel];
      shuffleArray(numbersLeft);
      placeBoardNumbers(numbersPanel);
      askNewQuestion(true);
    }

    function askNewQuestion(){
      if(!numbersLeft.length){
        if(isTimeMode){
          questionEl.textContent='„ÇØ„É™„Ç¢!üéâ';
          clearInterval(timerInterval);
          gameStarted=false;
          finalTimeEl.textContent=`„Çø„Ç§„É†: ${timerEl.textContent}`;
          gameOverMessage.style.display='flex';
          return;
        } else {
          shuffleArray(allNumbers);
          numbersLeft=allNumbers.slice(0,currentDifficulty);
        }
      }
      currentTarget=numbersLeft[0];
      questionEl.textContent=`${currentTarget} „ÇíÊé¢„ÅõÔºÅ`;
      if(!gameStarted){
        if(isTimeMode){
          startTime=Date.now();
          timerInterval=setInterval(updateTimer,1000);
        } else {
          startTime=Date.now();
          timerEl.textContent='00:00';
        }
        gameStarted=true;
        lastTapTime=Date.now();
      }
    }

    function updateTimer(){
      const t=Date.now()-startTime;
      const m=Math.floor(t/60000), s=Math.floor((t%60000)/1000);
      timerEl.textContent=
        `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function handleNumberClick(e){
      if(!gameStarted||!numbersLeft.length) return;
      const tapped=parseInt(e.target.dataset.number,10);
      if(tapped!==currentTarget) return;

      const interval=(Date.now()-lastTapTime)/1000;
      lastTapTime=Date.now();
      if(!isTimeMode) tapTimes.push(interval);

      if(isTimeMode){
        e.target.classList.add('found');
      } else {
        const rect=measureCellRect(e.target);
        placedRects=placedRects.filter(r=>
          !(Math.abs(r.left-rect.left)<1&&Math.abs(r.top-rect.top)<1)
        );
        e.target.remove();

        // Êó¢Â≠ò„Å´„Å™„ÅÑÊï∞Â≠ó„ÅÆ„Éó„Éº„É´
        const exist=Array.from(
          gameBoard.querySelectorAll('.number-cell')
        ).map(c=>parseInt(c.dataset.number,10));
        const pool=allNumbers.filter(n=>!exist.includes(n));
        if(pool.length){
          for(let i=0;i<5;i++){
            const num=pool[getRandomInt(0,pool.length-1)];
            if(addNumberToBoard(num)) break;
          }
        }
      }

      numbersLeft=numbersLeft.filter(n=>n!==tapped);
      askNewQuestion();
    }

    function addNumberToBoard(num){
      const cell=createNumberCell(num);
      cell.style.visibility='hidden';
      gameBoard.appendChild(cell);
      const w=cell.offsetWidth, h=cell.offsetHeight;
      const pos=findValidPosition(w,h);
      if(pos){
        cell.style.left=pos.left+'px';
        cell.style.top=pos.top+'px';
        cell.style.visibility='visible';
        placedRects.push(pos.rect);
        cell.addEventListener('click',handleNumberClick);
        enableDrag(cell);
        return cell;
      }
      gameBoard.removeChild(cell);
      return null;
    }

    function isOverlapping(newR, rects, pad=5){
      for(const r of rects){
        if(!(newR.right+pad<r.left-pad||
             newR.left-pad>r.right+pad||
             newR.bottom+pad<r.top-pad||
             newR.top-pad>r.bottom+pad)){
          return true;
        }
      }
      return false;
    }

    function findValidPosition(cellW,cellH){
      let attempt=0, max=MAX_ATTEMPTS*3;
      while(attempt<max){
        const top=getRandomInt(5,Math.max(5,gameBoard.clientHeight-cellH-5));
        const left=getRandomInt(5,Math.max(5,gameBoard.clientWidth-cellW-5));
        const rect={
          left,top,width:cellW,height:cellH,
          get right(){return this.left+this.width;},
          get bottom(){return this.top+this.height;}
        };
        if(!isOverlapping(rect,placedRects,8)){
          return {left,top,rect};
        }
        attempt++;
      }
      if(attempt>=max&&placedRects.length){
        placedRects=[];
        return findValidPosition(cellW,cellH);
      }
      return null;
    }

    function enableDrag(cell){
      let offX,offY,boardR,oldR;
      cell.addEventListener('mousedown',e=>{
        if(e.button!==0) return;
        e.preventDefault();
        boardR=gameBoard.getBoundingClientRect();
        oldR=measureCellRect(cell);
        placedRects=placedRects.filter(r=>
          !(Math.abs(r.left-oldR.left)<1&&Math.abs(r.top-oldR.top)<1)
        );
        offX=e.clientX-cell.getBoundingClientRect().left;
        offY=e.clientY-cell.getBoundingClientRect().top;
        const onMove=evt=>{
          let x=evt.clientX-boardR.left-offX;
          let y=evt.clientY-boardR.top-offY;
          x=Math.max(0,Math.min(x,gameBoard.clientWidth-cell.offsetWidth));
          y=Math.max(0,Math.min(y,gameBoard.clientHeight-cell.offsetHeight));
          cell.style.left=x+'px';
          cell.style.top=y+'px';
        };
        const onUp=()=>{
          document.removeEventListener('mousemove',onMove);
          document.removeEventListener('mouseup',onUp);
          placedRects.push(measureCellRect(cell));
        };
        document.addEventListener('mousemove',onMove);
        document.addEventListener('mouseup',onUp);
      });
    }

    function showTapTimesChart(){
      chartSection.style.display='flex';
      if(chartObj) chartObj.destroy();
      chartObj=new Chart(chartCanvas,{
        type:'line',
        data:{
          labels:tapTimes.map((v,i)=>`${i+1}ÂõûÁõÆ`),
          datasets:[{
            label:'Áô∫Ë¶ã„Å´„Åã„Åã„Å£„ÅüÁßí',
            data:tapTimes,
            borderColor:'#f1c40f',
            fill:false,pointBackgroundColor:'#e74c3c'
          }]
        },
        options:{
          responsive:true,maintainAspectRatio:false,
          plugins:{
            legend:{display:false},
            title:{display:true,text:'Êï∞Â≠óÁô∫Ë¶ã„Å´„Åã„Åã„Å£„ÅüÊôÇÈñìÂ±•Ê≠¥'}
          },
          scales:{
            y:{beginAtZero:true,title:{display:true,text:'Áßí'}},
            x:{title:{display:true,text:'Áô∫Ë¶ãÊï∞ÔºàÂõûÔºâ'}}
          }
        }
      });
    }

    resetButton.addEventListener('click',setupGame);
    difficultySelect.addEventListener('change',e=>{
      currentDifficulty=parseInt(e.target.value,10);
      localStorage.setItem('gameDifficulty',currentDifficulty);
      setupGame();
    });
    timeModeRadio.addEventListener('change',()=>{
      isTimeMode=true; setupGame();
    });
    relaxModeRadio.addEventListener('change',()=>{
      isTimeMode=false; setupGame();
    });
    endlessStopButton.addEventListener('click',()=>{
      if(tapTimes.length) showTapTimesChart();
    });
    closeChartBtn.addEventListener('click',()=>chartSection.style.display='none');

    let resizeTimer;
    window.addEventListener('resize',()=>{
      if(handlingResize) return;
      handlingResize=true;
      clearTimeout(resizeTimer);
      resizeTimer=setTimeout(()=>{
        setupGame();
        handlingResize=false;
      },300);
    });

    window.addEventListener('DOMContentLoaded',()=>{
      const saved=localStorage.getItem('gameDifficulty');
      if(saved){
        currentDifficulty=parseInt(saved,10);
        difficultySelect.value=currentDifficulty;
      }
      setTimeout(()=>{
        isTimeMode=!relaxModeRadio.checked;
        setupGame();
      },50);
    });
  </script>
</body>
</html>
