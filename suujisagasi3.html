<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Êï∞Â≠óÊé¢„ÅóËÑ≥„Éà„É¨„Ç≤„Éº„É† - Â§öÊï∞„Åã„Çâ1ÂÄãÊé¢„Åó</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  html, body {
    height: 100%; margin: 0; padding: 0; overflow: hidden;
    font-family: 'Arial', sans-serif;
    background-color: #3498db; color: #fff; user-select: none;
    display: flex; justify-content: center; align-items: center;
  }
  #game-container {
    width: 90vw; max-width: 700px;
    height: 90vh; max-height: 900px;
    background-color: #2c3e50; border-radius: 15px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    display: flex; flex-direction: column; align-items: center;
    padding: 1.5vh 1.5vw;
    box-sizing: border-box;
    position: relative;
  }
  .header {
    width: 100%;
    margin-bottom: 1vh;
    display: flex; flex-direction: column; align-items: center;
  }
  .mode-selection {
    display: flex; justify-content: center; gap: 15px; margin-bottom: 1vh;
  }
  .mode-selection input[type=radio] {
    display: none;
  }
  .mode-selection label {
    background: #f1c40f; color: #2c3e50;
    padding: 8px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.1em;
  }
  .mode-selection input[type=radio]:checked + label {
    background: #e74c3c;
    color: white;
  }
  #reset-button, #endless-stop-button {
    background-color: #f1c40f;
    color: #2c3e50;
    border: none;
    border-radius: 8px;
    padding: 10px 25px;
    font-size: 1.1em;
    font-weight: 600;
    cursor: pointer;
    margin: 0 10px 1vh 10px;
  }
  #reset-button:active, #endless-stop-button:active {
    transform: scale(0.95);
  }
  .difficulty-selection {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
    margin-bottom: 1.5vh;
  }
  .difficulty-selection input[type=radio] {
    display: none;
  }
  .difficulty-selection label {
    background-color: #f1c40f;
    color: #2c3e50;
    border-radius: 8px;
    text-align: center;
    padding: 6px 0;
    font-weight: 600;
    font-size: 1em;
    cursor: pointer;
  }
  .difficulty-selection input[type=radio]:checked + label {
    background-color: #e74c3c;
    color: white;
  }
  #question {
    width: 100%;
    background: white;
    color: #2c3e50;
    font-weight: 700;
    font-size: 1.7em;
    padding: 0.8vh 15vw;
    border-radius: 10px;
    margin-bottom: 1vh;
    box-sizing: border-box;
    text-align: center;
  }
  #timer {
    font-size: 1.3em;
    font-weight: 700;
    color: #f1c40f;
    display: none;
    text-align: right;
    width: 100%;
    margin-bottom: 1vh;
  }
  #game-board {
    width: 100%;
    flex-grow: 1;
    background-color: #ecf0f1;
    border-radius: 10px;
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    grid-auto-rows: minmax(2.9rem, auto);
    gap: 5px;
    padding: 10px;
    box-sizing: border-box;
    overflow-y: auto;
    user-select: none;
  }
  .number-cell {
    font-weight: 700;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    white-space: nowrap;
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 2px 6px #8884;
    border-radius: 6px;
    outline: solid 2px #ddd6;
    font-size: 1.2rem;
    color: #000;
    transition: opacity 0.3s;
  }
  .number-cell.found {
    opacity: 0.2;
    pointer-events: none;
    filter: grayscale(1);
  }
  #game-over-message {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.7); color: #fff; display: none;
    flex-direction: column; justify-content: center; align-items: center;
    border-radius: 10px; font-size: clamp(1.8em,6vw,2.5em); font-weight: bold;
    z-index: 20;
  }
  #game-over-message p {
    margin: 10px 0;
  }
  #final-time {
    color: #f1c40f;
    font-size: 1.3em;
  }
  #chart-section {
    display: none;
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(10,10,40, 0.95);
    z-index: 22;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }
  #chart-canvas {
    max-width: 90vw;
    max-height: 50vh;
    background: #fff;
    border-radius: 16px;
  }
  #close-chart {
    margin-top: 16px;
    padding: 1em 2em;
    font-size: 1.2em;
    background: #f1c40f;
    color: #2c3e50;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
  }
  #close-chart:active {
    background: #fff24a;
  }
</style>
</head>
<body>
  <div id="game-container">
    <div class="header">
      <div class="mode-selection">
        <input type="radio" id="timeMode" name="gameMode" value="time" />
        <label for="timeMode">„Çø„Ç§„É†</label>
        <input type="radio" id="relaxMode" name="gameMode" value="relax" checked />
        <label for="relaxMode">„É™„É©„ÉÉ„ÇØ„Çπ</label>
      </div>
      <div style="display:flex; justify-content:center; gap: 10px; flex-wrap: wrap;">
        <button id="reset-button" title="„É™„Çª„ÉÉ„Éà">üîÑ „É™„Çª„ÉÉ„Éà</button>
        <button id="endless-stop-button">ÁµÇ‰∫Ü</button>
      </div>
      <div class="difficulty-selection">
        <input type="radio" id="diff10" name="difficulty" value="10" checked />
        <label for="diff10">10</label>
        <input type="radio" id="diff20" name="difficulty" value="20" />
        <label for="diff20">20</label>
        <input type="radio" id="diff30" name="difficulty" value="30" />
        <label for="diff30">30</label>
        <input type="radio" id="diff40" name="difficulty" value="40" />
        <label for="diff40">40</label>
        <input type="radio" id="diff50" name="difficulty" value="50" />
        <label for="diff50">50</label>
        <input type="radio" id="diff60" name="difficulty" value="60" />
        <label for="diff60">60</label>
        <input type="radio" id="diff70" name="difficulty" value="70" />
        <label for="diff70">70</label>
        <input type="radio" id="diff80" name="difficulty" value="80" />
        <label for="diff80">80</label>
        <input type="radio" id="diff90" name="difficulty" value="90" />
        <label for="diff90">90</label>
        <input type="radio" id="diff100" name="difficulty" value="100" />
        <label for="diff100">100</label>
      </div>
      <div id="question"></div>
      <div id="timer">00:00</div>
    </div>

    <div id="game-board"></div>

    <div id="game-over-message">
      <p>„Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ</p>
      <p id="final-time"></p>
    </div>

    <div id="chart-section">
      <canvas id="chart-canvas"></canvas>
      <button id="close-chart">Èñâ„Åò„Çã</button>
    </div>
  </div>

  <script>
    const COLORS = [
      '#e74c3c', '#f39c12', '#1abc9c', '#2980b9', '#8e44ad',
      '#2c3e50', '#d35400', '#c0392b', '#16a085', '#34495e',
      '#9b59b6', '#3498db', '#f1c40f', '#e67e22', '#7f8c8d'
    ];
    const MIN_NUMBER = 1, MAX_NUMBER = 100;

    const gameBoard = document.getElementById('game-board');
    const questionEl = document.getElementById('question');
    const resetButton = document.getElementById('reset-button');
    const difficultyRadios = document.querySelectorAll('input[name="difficulty"]');
    const timerEl = document.getElementById('timer');
    const gameOverMessage = document.getElementById('game-over-message');
    const finalTimeEl = document.getElementById('final-time');
    const timeModeRadio = document.getElementById('timeMode');
    const relaxModeRadio = document.getElementById('relaxMode');
    const endlessStopButton = document.getElementById('endless-stop-button');
    const chartSection = document.getElementById('chart-section');
    const closeChartBtn = document.getElementById('close-chart');
    const chartCanvas = document.getElementById('chart-canvas');

    let allNumbers = [], numbersPanel = [], numbersLeft = [], currentTarget = null;
    let gameStarted = false, startTime = 0, timerInterval = null;
    let currentDifficulty = 10, isTimeMode = false;
    let tapTimes = [], lastTapTime = 0, chartObj = null, handlingResize = false;

    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function createNumberCell(num) {
      const cell = document.createElement('div');
      cell.classList.add('number-cell');
      cell.textContent = num;
      cell.dataset.number = num;
      cell.style.color = COLORS[getRandomInt(0, COLORS.length - 1)];
      return cell;
    }

    function placeBoardNumbers(nums) {
      gameBoard.innerHTML = '';
      nums.forEach((num) => {
        const cell = createNumberCell(num);
        gameBoard.appendChild(cell);
        cell.addEventListener('click', handleNumberClick);
      });
    }

    function setupGame() {
      if (chartObj) { chartObj.destroy(); chartObj = null; }
      chartSection.style.display = 'none';
      gameOverMessage.style.display = 'none';
      clearInterval(timerInterval);
      timerEl.textContent = '00:00';
      gameStarted = false;
      tapTimes = [];
      lastTapTime = 0;

      allNumbers = [];
      for (let i = MIN_NUMBER; i <= MAX_NUMBER; i++) allNumbers.push(i);
      shuffleArray(allNumbers);
      numbersPanel = allNumbers.slice(0, currentDifficulty);
      numbersLeft = [...numbersPanel];
      shuffleArray(numbersLeft);

      placeBoardNumbers(numbersPanel);
      askNewQuestion();
    }

    function askNewQuestion() {
      if (isTimeMode) {
        if (numbersLeft.length > 0) {
          currentTarget = numbersLeft.shift();
          questionEl.textContent = `${currentTarget} „ÇíÊé¢„ÅõÔºÅ`;
        } else {
          gameStarted = false;
          clearInterval(timerInterval);
          gameOverMessage.style.display = 'flex';
          finalTimeEl.textContent = `„Çø„Ç§„É†: ${timerEl.textContent}`;
          if (chartObj) chartObj.destroy();
          chartObj = null;
        }
      } else { // Relax Mode
        if (numbersLeft.length === 0) {
          numbersLeft = [...numbersPanel];
          shuffleArray(numbersLeft);
        }
        currentTarget = numbersLeft.shift();
        questionEl.textContent = `${currentTarget} „ÇíÊé¢„ÅõÔºÅ`;
      }
    }

    function updateTimer() {
      const t = Date.now() - startTime;
      const m = Math.floor(t / 60000), s = Math.floor((t % 60000) / 1000);
      timerEl.textContent =
        `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function handleNumberClick(e) {
      const tapped = parseInt(e.target.dataset.number, 10);
      if (tapped !== currentTarget) return;

      if (!gameStarted) {
        startTime = Date.now();
        lastTapTime = startTime;
        timerEl.style.display = 'block';
        timerInterval = setInterval(updateTimer, 1000);
        gameStarted = true;
      }
      
      const interval = (Date.now() - lastTapTime)/1000;
      lastTapTime = Date.now();
      tapTimes.push(interval);

      if (isTimeMode) {
        const cell = e.target;
        cell.classList.add('found');
      } else {
        const existingNumbers = Array.from(gameBoard.querySelectorAll('.number-cell'))
          .map(c => parseInt(c.dataset.number, 10));

        const allNumbersPool = [];
        for (let i = MIN_NUMBER; i <= MAX_NUMBER; i++) {
          if (!existingNumbers.includes(i)) {
            allNumbersPool.push(i);
          }
        }
        
        if (allNumbersPool.length > 0) {
          const newNumber = allNumbersPool[getRandomInt(0, allNumbersPool.length - 1)];
          const cell = e.target;
          cell.textContent = newNumber;
          cell.dataset.number = newNumber;
          cell.style.color = COLORS[getRandomInt(0, COLORS.length - 1)];
          
          numbersPanel = Array.from(gameBoard.querySelectorAll('.number-cell'))
            .map(c => parseInt(c.dataset.number, 10));

          numbersLeft = [...numbersPanel];
          shuffleArray(numbersLeft);
        } else {
          // ÂÖ®„Å¶„ÅÆÊï∞Â≠ó„ÅåÈÖçÁΩÆ„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„É™„Çª„ÉÉ„Éà
          setupGame();
          return;
        }
      }
      askNewQuestion();
    }

    resetButton.addEventListener('click', () => {
        isTimeMode = timeModeRadio.checked;
        setupGame();
    });
    difficultyRadios.forEach(radio => {
      radio.addEventListener('change', ev => {
        currentDifficulty = parseInt(ev.target.value, 10);
        localStorage.setItem('gameDifficulty', currentDifficulty);
        isTimeMode = timeModeRadio.checked;
        setupGame();
      });
    });

    timeModeRadio.addEventListener('change', () => {
      isTimeMode = true;
      timerEl.style.display = 'block';
      setupGame();
    });
    relaxModeRadio.addEventListener('change', () => {
      isTimeMode = false;
      timerEl.style.display = 'none';
      setupGame();
    });

    endlessStopButton.addEventListener('click', () => {
      if (!isTimeMode) {
        if (!tapTimes.length) return;
        gameStarted = false;
        clearInterval(timerInterval);
        showTapTimesChart();
      }
    });

    function showTapTimesChart() {
      chartSection.style.display = 'flex';
      if (chartObj) chartObj.destroy();
      chartObj = new Chart(chartCanvas, {
        type: 'line',
        data: {
          labels: tapTimes.map((v, i) => `${i + 1}ÂõûÁõÆ`),
          datasets: [{
            label: 'Áô∫Ë¶ã„Å´„Åã„Åã„Å£„ÅüÁßí',
            data: tapTimes,
            borderColor: '#f1c40f',
            fill: false, pointBackgroundColor: '#e74c3c'
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Êï∞Â≠óÁô∫Ë¶ã„Å´„Åã„Åã„Å£„ÅüÊôÇÈñìÂ±•Ê≠¥' }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Áßí' } },
            x: { title: { display: true, text: 'Áô∫Ë¶ãÊï∞ÔºàÂõûÔºâ' } }
          }
        }
      });
    }

    closeChartBtn.addEventListener('click', () => {
      chartSection.style.display = 'none';
      setupGame();
    });

    let resizeTimer;
    window.addEventListener('resize', () => {
      if (handlingResize) return;
      handlingResize = true;
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        setupGame();
        handlingResize = false;
      }, 300);
    });

    window.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('gameDifficulty');
      if (saved) {
        currentDifficulty = parseInt(saved, 10);
        document.querySelector(`input[name="difficulty"][value="${saved}"]`).checked = true;
      }
      
      relaxModeRadio.checked = true;
      isTimeMode = false;
      timerEl.style.display = 'none';
      setupGame();
    });
  </script>
</body>
</html>
