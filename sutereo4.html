<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¶…è¦–èªæ€§ã‚¹ãƒ†ãƒ¬ã‚ªã‚°ãƒ©ãƒ ãƒ»çœŸ</title>
  <style>
    :root {
      --bg-color: #020617;
      --card-bg: #1e293b;
      --highlight: #f43f5e;
      --text-color: #f1f5f9;
      --correct: #10b981;
    }
    
    * { box-sizing: border-box; touch-action: manipulation; }
    
    body {
      font-family: 'Hiragino Kaku Gothic ProN', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }
    
    .container {
      width: 100%;
      max-width: 800px;
      text-align: center;
    }

    h1 { font-size: 1.2rem; color: var(--highlight); margin: 5px 0; }

    /* ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ */
    .canvas-wrapper {
      position: relative;
      margin: 10px 0;
      background: #000;
      border-radius: 8px;
      line-height: 0;
      box-shadow: 0 0 30px rgba(0,0,0,1);
    }
    canvas {
      width: 100%;
      height: auto;
      border-radius: 8px;
      image-rendering: pixelated; /* ç ‚åµã‚’ã¯ã£ãã‚Šã•ã›ã‚‹ */
    }

    /* è¨­å®šã‚¨ãƒªã‚¢ */
    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    select, button {
      padding: 15px 5px;
      border-radius: 12px;
      border: none;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
    }
    #changeNumber { background: #3b82f6; color: white; }
    #recoveryMode { background: #8b5cf6; color: white; }
    .mode-active { box-shadow: 0 0 15px white; }

    /* å·¨å¤§å…¥åŠ›æ¬„ */
    .input-display {
      background: #000;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 12px;
      font-size: 2.5rem;
      font-weight: bold;
      min-height: 60px;
      color: #fff;
      border: 2px solid #334155;
    }

    /* å·¨å¤§ãƒ†ãƒ³ã‚­ãƒ¼ */
    .numpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-width: 500px;
      margin: 0 auto;
    }
    .num-btn {
      background: #334155;
      color: white;
      padding: 25px 0;
      font-size: 2rem;
      border-radius: 15px;
    }
    .num-btn:active { background: #475569; }
    .num-btn.submit { background: var(--highlight); grid-column: span 2; }
    .num-btn.del { background: #64748b; }

    /* çµæœãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    #resultOverlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      font-size: 2rem;
    }
    .ans-val { font-size: 5rem; color: white; margin: 20px; }

    .option-row { margin: 10px 0; font-size: 0.9rem; display: flex; justify-content: center; gap: 20px; }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ‘ï¸ è¶…è¦–èªæ€§ã‚¹ãƒ†ãƒ¬ã‚ªã‚°ãƒ©ãƒ ãƒ»çœŸ</h1>
  
  <div class="controls">
    <select id="levelSelect">
      <option value="1">1æ¡</option>
      <option value="2">2æ¡</option>
      <option value="3">3æ¡</option>
    </select>
    <button id="changeNumber">ğŸ”„ æ¬¡ã®å•é¡Œ</button>
  </div>

  <div class="option-row">
    <label><input type="checkbox" id="bwMode" checked> ç™½é»’ãƒ¢ãƒ¼ãƒ‰</label>
    <button id="recoveryMode" style="padding: 5px 10px; font-size: 0.8rem;">ğŸ§˜ è¦–åŠ›å›å¾© OFF</button>
  </div>

  <div class="canvas-wrapper">
    <!-- ã‚¹ãƒ†ãƒ¬ã‚ªã‚°ãƒ©ãƒ æœ¬ä½“ -->
    <canvas id="stereoCanvas" width="800" height="450"></canvas>
  </div>

  <div class="input-display" id="guessDisplay"></div>

  <div class="numpad">
    <button class="num-btn" data-val="7">7</button>
    <button class="num-btn" data-val="8">8</button>
    <button class="num-btn" data-val="9">9</button>
    <button class="num-btn" data-val="4">4</button>
    <button class="num-btn" data-val="5">5</button>
    <button class="num-btn" data-val="6">6</button>
    <button class="num-btn" data-val="1">1</button>
    <button class="num-btn" data-val="2">2</button>
    <button class="num-btn" data-val="3">3</button>
    <button class="num-btn del" data-val="del">æ¶ˆ</button>
    <button class="num-btn" data-val="0">0</button>
    <button class="num-btn submit" id="submitBtn">å›ç­”</button>
  </div>
</div>

<div id="resultOverlay">
  <div id="resultStatus"></div>
  <div class="ans-val" id="correctValue"></div>
  <div style="font-size: 1rem;">æ¬¡ã®å•é¡Œã¸é€²ã¿ã¾ã™...</div>
</div>

<script>
  const canvas = document.getElementById('stereoCanvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width;
  const H = canvas.height;
  
  let currentAnswer = "";
  let currentGuess = "";
  let recoveryActive = false;
  let recoveryFrame = 0;

  // å®Œå…¨ã«å‡ä¸€ãªç ‚åµã‚’ä½œã‚‹ãŸã‚ã®è¨­å®š
  const DPI = 72;
  const EYE_SEP = DPI * 2.5; // æ¨™æº–çš„ãªç›®ã®é–“éš”
  const MU = 0.33; // å¥¥è¡Œãä¿‚æ•°

  function getRandomColor() {
    const isBW = document.getElementById('bwMode').checked;
    if (isBW) {
      const v = Math.random() > 0.5 ? 255 : 0; // ç™½ã‹é»’ã®2å€¤ã«ã™ã‚‹ã¨æœ€ã‚‚éš è”½æ€§ãŒé«˜ã„
      return [v, v, v];
    } else {
      const r = Math.random() > 0.5 ? 255 : 0;
      const g = Math.random() > 0.5 ? 255 : 0;
      const b = Math.random() > 0.5 ? 255 : 0;
      return [r, g, b];
    }
  }

  // éš ã—ç”»åƒã®ç”Ÿæˆï¼ˆãƒ¡ãƒ¢ãƒªä¸Šã®ã¿ï¼‰
  function getDepthData(text) {
    const dCanvas = document.createElement('canvas');
    dCanvas.width = W;
    dCanvas.height = H;
    const dCtx = dCanvas.getContext('2d');
    dCtx.fillStyle = "black";
    dCtx.fillRect(0, 0, W, H);

    const fontSize = text.length === 1 ? 380 : text.length === 2 ? 280 : 220;
    dCtx.font = `900 ${fontSize}px sans-serif`;
    dCtx.textAlign = 'center';
    dCtx.textBaseline = 'middle';
    dCtx.fillStyle = "white";
    // ã‚ãšã‹ã«ã¼ã‹ã—ã¦ç«‹ä½“æ„Ÿã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹ãŒã€ã‚¨ãƒƒã‚¸ãŒç«‹ãŸãªã„ã‚ˆã†ã«ã™ã‚‹
    dCtx.shadowColor = "white";
    dCtx.shadowBlur = 15;
    dCtx.fillText(text, W / 2, H / 2 + 20);
    
    return dCtx.getImageData(0, 0, W, H).data;
  }

  // SIRDSã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆãƒ”ã‚¯ã‚»ãƒ«é€£çµæ³•ï¼‰
  function drawSIRDS(offset = 0) {
    const depthData = getDepthData(currentAnswer);
    const imgData = ctx.createImageData(W, H);
    
    const curEyeSep = EYE_SEP + offset;

    for (let y = 0; y < H; y++) {
      const left = new Int32Array(W);
      const right = new Int32Array(W);
      
      for (let x = 0; x < W; x++) { left[x] = x; right[x] = x; }

      for (let x = 0; x < W; x++) {
        // æ·±åº¦å–å¾— (0.0 - 1.0)
        const z = depthData[(y * W + x) * 4] / 255;
        // åˆ†é›¢è·é›¢ã®è¨ˆç®—
        const sep = Math.floor((1 - MU * z) * curEyeSep / (2 - MU * z));
        
        let l = Math.floor(x - sep / 2);
        let r = l + sep;

        if (l >= 0 && r < W) {
          // ãƒ”ã‚¯ã‚»ãƒ«ã‚’ãƒªãƒ³ã‚¯ã•ã›ã‚‹ï¼ˆåŒã˜è‰²ã«ã™ã‚‹æŒ‡ç¤ºï¼‰
          let visible = true;
          // éš é¢æ¶ˆå»ã®ç°¡æ˜“åˆ¤å®š
          if (visible) {
            left[r] = l;
            right[l] = r;
          }
        }
      }

      const rowColors = new Uint8ClampedArray(W * 3);
      for (let x = 0; x < W; x++) {
        if (left[x] === x) {
          const c = getRandomColor();
          rowColors[x * 3] = c[0];
          rowColors[x * 3 + 1] = c[1];
          rowColors[x * 3 + 2] = c[2];
        } else {
          // ãƒªãƒ³ã‚¯ã•ã‚ŒãŸãƒ”ã‚¯ã‚»ãƒ«ã®è‰²ã‚’ã‚³ãƒ”ãƒ¼
          rowColors[x * 3] = rowColors[left[x] * 3];
          rowColors[x * 3 + 1] = rowColors[left[x] * 3 + 1];
          rowColors[x * 3 + 2] = rowColors[left[x] * 3 + 2];
        }
      }

      for (let x = 0; x < W; x++) {
        const idx = (y * W + x) * 4;
        imgData.data[idx] = rowColors[x * 3];
        imgData.data[idx+1] = rowColors[x * 3 + 1];
        imgData.data[idx+2] = rowColors[x * 3 + 2];
        imgData.data[idx+3] = 255;
      }
    }
    ctx.putImageData(imgData, 0, 0);
    drawGuideDots(offset);
  }

  function drawGuideDots(offset = 0) {
    const dotY = 25;
    const centerX = W / 2;
    const sep = (EYE_SEP + offset) / 2.8; 
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.arc(centerX - sep, dotY, 5, 0, 7);
    ctx.arc(centerX + sep, dotY, 5, 0, 7);
    ctx.fill();
  }

  function initGame() {
    const mode = document.getElementById('levelSelect').value;
    if (mode === "1") currentAnswer = Math.floor(Math.random() * 10).toString();
    else if (mode === "2") currentAnswer = Math.floor(Math.random() * 90 + 10).toString();
    else currentAnswer = Math.floor(Math.random() * 900 + 100).toString();

    currentGuess = "";
    document.getElementById('guessDisplay').textContent = "";
    document.getElementById('resultOverlay').style.display = "none";
    drawSIRDS();
  }

  // è¦–åŠ›å›å¾©ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  function animate() {
    if (!recoveryActive) return;
    recoveryFrame += 0.04;
    const offset = Math.sin(recoveryFrame) * 20;
    drawSIRDS(offset);
    requestAnimationFrame(animate);
  }

  // å…¥åŠ›å‡¦ç†
  document.querySelectorAll('.num-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const val = btn.dataset.val;
      if (val === 'del') currentGuess = currentGuess.slice(0, -1);
      else if (val) { if (currentGuess.length < 3) currentGuess += val; }
      document.getElementById('guessDisplay').textContent = currentGuess;
    });
  });

  document.getElementById('submitBtn').addEventListener('click', () => {
    if (!currentGuess) return;
    const overlay = document.getElementById('resultOverlay');
    const status = document.getElementById('resultStatus');
    const correctVal = document.getElementById('correctValue');
    
    overlay.style.display = "flex";
    correctVal.textContent = currentAnswer;
    
    if (currentGuess === currentAnswer) {
      status.textContent = "æ­£è§£ï¼ ç´ æ™´ã‚‰ã—ã„ï¼";
      status.style.color = "#10b981";
    } else {
      status.textContent = "æ®‹å¿µï¼ æ­£è§£ã¯...";
      status.style.color = "#f43f5e";
    }
    
    setTimeout(initGame, 2500);
  });

  document.getElementById('changeNumber').addEventListener('click', initGame);
  document.getElementById('recoveryMode').addEventListener('click', (e) => {
    recoveryActive = !recoveryActive;
    e.target.textContent = recoveryActive ? "ğŸ§˜ è¦–åŠ›å›å¾© ON" : "ğŸ§˜ è¦–åŠ›å›å¾© OFF";
    if (recoveryActive) animate(); else drawSIRDS();
  });

  window.onload = initGame;
</script>
</body>
</html>